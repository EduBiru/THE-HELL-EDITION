<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Finan√ßas do Biru ‚Äî Intelligence Edition</title>

<style>
  :root{
    --bg:#071428; --card:#0d1b2a; --muted:#94a3b8; --accent:#3B82F6; --panel:#081223;
    --glass: rgba(255,255,255,0.02);
    --text: #e6eef8;
    --green: #10B981;
    --red: #EF4444;
    --chart-line: #38BDF8; /* NOVO: Azul Ciano Brilhante */
    --chart-grid: rgba(255, 255, 255, 0.05);
  }
  body.light{
    --bg:#f6f7fb; --card:#ffffff; --muted:#475569; --accent:#2563eb; --panel:#ffffff; --glass: rgba(0,0,0,0.03);
    --text: #0b1220;
    color: #0b1220;
    --chart-line: #0EA5E9; /* Ciano mais escuro para fundo claro */
    --chart-grid: rgba(0, 0, 0, 0.05);
  }
  /* ATUALIZA√á√ÉO (10/30): Corrigindo o contraste do <select> */
  body.light .input, body.light select.input {
    background: var(--card); /* Fundo branco */
    border-color: #e5e7eb;
    color: var(--text); /* Texto escuro */
  }
  .input, select.input {
    background: var(--panel); /* Fundo azul escuro (painel) */
    border:1px solid var(--glass); 
    color:var(--text); 
    padding:8px 10px; 
    border-radius:8px; 
  }
  /* Garante que o <select> tenha a mesma apar√™ncia */
  select.input {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }
  /* --- FIM DA CORRE√á√ÉO DE CONTRASTE --- */

  body{ margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg, var(--bg) 0%, #071827 60%); color:var(--text); min-height:100vh;}
  .wrap{ max-width:1200px; margin:18px auto; padding:18px;}
  header.top{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content: space-between; } /* Atualizado */
  .title{ font-size:20px; font-weight:700; }
  .controls{ margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .btn{ background:var(--accent); color:#fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; box-shadow:0 6px 18px rgba(59,130,246,0.08); }
  .btn-ghost{ background:transparent; border:1px solid var(--glass); color:var(--muted); padding:7px 10px; border-radius:8px; cursor:pointer; }
  body.light .btn-ghost { border:1px solid var(--glass); }
  input[type=file]{ display:none; }
  
  .card{ background:linear-gradient(180deg, var(--glass), rgba(255,255,255,0.012)); border:1px solid var(--glass); padding:18px; border-radius:12px; box-shadow: 0 6px 18px rgba(2,6,23,0.6); margin-top:12px; }
  body.light .card { background: var(--card); border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
  .grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
  .chart-wrap{ height:340px; background:transparent; border-radius:8px; padding:10px; }
  .full-width{ grid-column:1/-1; }
  @media(max-width: 900px) {
    .grid { grid-template-columns: 1fr; }
    /* .controls removido, j√° √© flex-wrap */
    .search { width: 100%; }
    .top-right { margin-left: 0; }
  }
  #dailyChart, #barChart { width:100%; height:100%; }
  .small-muted{ color:var(--muted); font-size:13px; }
  #footer{ display:flex; justify-content:space-between; padding:8px 12px; color:var(--muted); font-size:13px; margin-top:14px; }
  .top-right { margin-left:auto; display:flex; gap:8px; align-items:center; }
  .pill{ background:var(--panel); padding:6px 10px; border-radius:999px; border:1px solid var(--glass); color:var(--muted); display:inline-flex; align-items:center; gap: 8px; cursor: pointer; }
  
  /* --- NOVOS ESTILOS INSIGHTS --- */
  .insights-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:12px; }
  .insight-card{ background:var(--panel); border:1px solid var(--glass); border-radius:8px; padding:14px; }
  .insight-card .small-muted { margin-bottom: 6px; }
  .insight-card h4 { font-size: 1.25rem; font-weight: 600; }
  .balance-bar-container { width: 100%; background: var(--glass); border-radius: 4px; height: 16px; overflow: hidden; }
  .balance-bar-in { background: var(--green); height: 100%; float: left; }
  .balance-bar-out { background: var(--red); height: 100%; float: left; }
  .insight-accent-green { color: var(--green); }
  .insight-accent-red { color: var(--red); }
  
  #outliersList{ margin-top:8px; max-height:160px; overflow:auto; }
  .switch{ display:inline-flex; align-items:center; gap:8px; }
  .icon-btn{ background:transparent; border:none; color:var(--muted); cursor:pointer; font-size:18px; }
  .search{ /* width:260px; */ padding:8px 10px; border-radius:8px; border:1px solid var(--glass); background:transparent; color:inherit; }
  .topbar-actions{ display:flex; gap:8px; align-items:center; }
  .hidden{ display:none!important; }

  /* --- NOVOS ESTILOS DO ACORDE√ÉO --- */
  .accordion-wrap { display:flex; flex-direction:column; gap:8px; }
  .accordion-item { background:var(--panel); border:1px solid var(--glass); border-radius:8px; }
  .accordion-header { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; cursor:pointer; font-weight:600; }
  .accordion-header:hover { background:var(--glass); }
  .accordion-content { max-height:0; overflow:hidden; transition:max-height 0.3s ease-out; padding: 0 14px; }
  .accordion-content.active { max-height:500px; overflow-y:auto; padding:10px 14px 14px; border-top:1px solid var(--glass); }
  .accordion-name { flex:1; display: inline-flex; align-items: center; gap: 8px; }
  
  /* ATUALIZADO: Substitu√≠do accordion-total por credit/debit */
  .accordion-total-credit, .accordion-total-debit {
    font-size: 15px;
    font-weight: 500;
    width: 120px;
    text-align: right;
  }
  .accordion-total-credit { color: var(--green); }
  .accordion-total-debit { color: var(--red); }
  
  .accordion-icon { transition:transform 0.3s; margin-left: 8px; }
  .accordion-icon.rotated { transform:rotate(90deg); }
  
  /* ATUALIZADO: Itens de Transa√ß√£o (tx-item) */
  .tx-item { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid var(--glass); font-size:13px; align-items: center; }
  .tx-item:last-child { border-bottom:none; }
  /* ATUALIZA√á√ÉO (10/30): Corrigindo contraste da lista */
  .tx-hist { 
    flex:1; 
    color:var(--text); /* USA A COR DE TEXTO PRINCIPAL (BRANCO) */
    max-width:50%; 
    overflow:hidden; 
    text-overflow:ellipsis; 
    white-space:nowrap; 
  }
  .tx-item:hover {
    background: var(--glass); /* Fundo azulado leve no hover */
  }
  
  .tx-date { color:var(--muted); width:80px; }
  .tx-credit, .tx-debit {
    font-weight:500;
    width: 110px;
    text-align: right;
  }
  .tx-credit { color:var(--green); }
  .tx-debit { color:var(--red); }
  /* NOVO: Destaque para transa√ß√£o selecionada */
  .tx-item.tx-selected {
      background: rgba(59, 130, 246, 0.1); /* Cor de destaque azul suave */
      border-left: 3px solid var(--accent);
      padding-left: 11px;
  }

  /* --- NOVO: Controles do Acorde√£o --- */
  /* ATUALIZADO: √çcone de Ocultar ("Bolinha") */
  .accordion-hide-icon {
    cursor: pointer;
    width: 14px; /* Tamanho da bolinha */
    height: 14px; /* Tamanho da bolinha */
    border: 2px solid var(--muted); /* Borda cinza transl√∫cida */
    border-radius: 50%;
    margin-right: 8px;
    opacity: 0.6;
    transition: all 0.2s;
    flex-shrink: 0; /* Impede que a bolinha encolha */
  }
  .accordion-hide-icon:hover {
    opacity: 1;
    border-color: var(--accent);
  }
  /* O CSS da bolinha OCULTA (vermelha) */
  .accordion-hide-icon.hidden {
    opacity: 1;
    background-color: var(--red); /* Preenchimento vermelho */
    border-color: var(--red); /* Borda vermelha */
  }

  .accordion-save-icon { 
    cursor: pointer;
    font-size: 16px;
    margin-left: 8px;
    opacity: 0.6;
  }
  .accordion-save-icon:hover {
    opacity: 1;
    color: var(--accent);
  }
  .accordion-edit-input {
    flex: 1;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid var(--accent);
    background: var(--panel);
    color: var(--text);
    font-weight: 600;
  }
  /* --- Fim dos Controles do Acorde√£o --- */


  /* --- Year Filter Cards --- */
  #yearFilterContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px 0;
    margin-top: 12px;
  }
  .year-card {
    background: var(--card);
    border: 1px solid var(--glass);
    border-radius: 8px;
    padding: 8px 12px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .year-card:hover {
    background: var(--glass);
    border-color: var(--accent);
    color: var(--accent);
  }
  .year-card.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
    box-shadow: 0 2px 4px rgba(59,130,246,0.3);
  }

  /* --- NOVO: EDITOR DE ALIASES --- */
  #nameAliasesEditor {
    width: 100%;
    height: 250px;
    font-family: monospace;
    font-size: 13px;
    background: var(--panel);
    color: var(--text);
    border: 1px solid var(--glass);
    border-radius: 8px;
    padding: 10px;
  }
  
  /* --- NOVO: Estilo para o cabe√ßalho do acorde√£o do editor --- */
  #aliasEditorHeader {
    padding: 0;
    margin-bottom: 10px;
  }
  #aliasEditorHeader h4 {
    flex: 1;
    padding: 12px 0 12px 14px; /* Simula o padding do accordion-header */
  }
  #aliasEditorIcon {
    padding: 12px 14px; /* Garante √°rea de clique */
  }
  #aliasEditorContent.active {
    max-height: 400px; /* Altura suficiente para o editor */
    padding: 0; /* Conte√∫do interno j√° tem padding/margin */
  }

  /* --- NOVO: Estilos do √çcone de Status --- */
  #statusIcon {
    display: inline-block;
    width: 18px; /* Tamanho do √≠cone */
    height: 18px; /* Tamanho do √≠cone */
    font-size: 16px;
    line-height: 1;
    text-align: center;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Transi√ß√£o com "bounce" */
  }
  #statusIcon.visible {
    opacity: 1;
    transform: scale(1);
    color: var(--green);
  }
  #statusIcon.loading {
    opacity: 1;
    transform: scale(1);
    color: var(--muted);
    border: 2px solid var(--glass);
    border-top-color: var(--accent);
    border-radius: 50%;
    width: 14px; /* Ajuste de tamanho para o spinner */
    height: 14px; /* Ajuste de tamanho para o spinner */
    animation: spin 1s linear infinite;
  }
  #statusIcon.error {
    opacity: 1;
    transform: scale(1);
    color: var(--red);
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* NOVO: Destaque visual para grupos ignorados no acorde√£o */
  .ignored-item .accordion-header {
    opacity: 0.6;
    border-left: 3px dashed var(--muted);
  }

/* PATCH ADDED: CSS for ignored list and tx buttons (Consolidado) */
.ignored-row {
  background: var(--panel);
  border: 1px solid var(--glass);
  border-radius: 8px;
  padding: 8px 12px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  color: var(--text);
  font-size: 14px;
}
.btn-ghost { background: transparent; border:1px solid rgba(255,255,255,.06); color:var(--muted); padding:7px 10px; border-radius:8px; cursor:pointer; }
.btn-ghost.active { background: var(--glass); color: var(--text); border-color: rgba(255,255,255,.12); }
.tx-ignore-btn { width:20px;height:20px;border-radius:50%;text-align:center;line-height:18px; border:none; background:transparent; cursor:pointer; color: var(--text); } /* CORRIGIDO: Cor clara */
.tx-edit-btn, .tx-move-btn { border:none; background:transparent; cursor:pointer; margin-left:4px; color: var(--text); } /* CORRIGIDO: Cor clara */
.tx-item.tx-ignored .tx-ignore-btn { color: var(--text); background-color: var(--red); border: none; } /* CORRIGIDO: Bot√£o Ignorar Marcado */

.autocomplete-suggestion {
    padding: 8px 10px;
    cursor: pointer;
    border-bottom: 1px solid var(--glass);
    font-size: 14px;
}
.autocomplete-suggestion:last-child {
    border-bottom: none;
}
.autocomplete-suggestion:hover {
    background: var(--glass);
    color: var(--accent);
}

.ignored-item .accordion-header { opacity: 0.8; border-left: 3px dashed rgba(255,255,255,0.04); }
#ignoredList { max-height: 360px; overflow:auto; padding-right:6px; }

/* Controles do topo (CSV/JSON/tema) */
.top-controls {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

/* Bot√£o padr√£o do topo */
.top-btn {
  padding: 8px 14px;
  border-radius: 8px;
  background: var(--glass);
  color: var(--text);
  border: 1px solid rgba(255,255,255,0.05);
  cursor: pointer;
  font-size: 13px;
  display:flex;
  align-items:center;
  justify-content:center;
  transition: all .2s ease;
}

/* Efeito hover */
.top-btn:hover {
  background: rgba(255,255,255,0.08);
  border-color: rgba(255,255,255,0.12);
}

/* Quando arquivo CSV estiver carregado ‚úÖ */
.top-btn.csv-loaded {
  background: rgba(16,185,129,0.18); /* verdinho suave transl√∫cido */
  border-color: rgba(16,185,129,0.35);
  color: var(--green);
}

/* Quando deu erro ao ler CSV ‚ùå */
.top-btn.csv-error {
  background: rgba(239,68,68,0.18); /* vermelho suave */
  border-color: rgba(239,68,68,0.45);
  color: var(--red);
}

/* Bot√£o do modo dark/light, com moldura */
.theme-btn {
  padding:6px 10px;
  border-radius:8px;
  background: var(--glass);
  border:1px solid rgba(255,255,255,.05);
  font-size: 13px;
  cursor:pointer;
  display:flex;
  align-items:center;
}

</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body class="dark">
<div class="wrap" id="app">

<header class="top">
  <div>
    <div class="title">Finan√ßas do Biru ‚Äî Intelligence Edition</div>
    <div class="small-muted">Offline ¬∑ Bradesco / CSVs comuns. Processamento autom√°tico.</div>
  </div>

  <div class="top-controls">

    <label for="fileInput" id="fileInputLabel" class="top-btn" style="min-width:90px;">
      CSV
    </label>
    <input id="fileInput" type="file" accept=".csv,.txt" style="display:none;" />

    <button id="exportBackup" class="top-btn">Backup JSON</button>

    <button id="importBackup" class="top-btn">Importar JSON</button>

    <button id="printScreen" class="top-btn">Imprimir</button>

    <button id="themeToggle" class="top-btn theme-btn" aria-label="tema">üåô</button>

  </div>
</header>

  
  <section class="grid">
    <div class="card">
      <p class="small-muted">Total Entradas</p>
      <h3 id="totalIn">R$ 0,00</h3>
    </div>
    <div class="card">
      <p class="small-muted">Total Sa√≠das</p>
      <h3 id="totalOut">R$ 0,00</h3>
    </div>
    <div class="card">
      <p class="small-muted">Saldo L√≠quido</p>
      <h3 id="saldo">R$ 0,00</h3>
    </div>
  </section>

  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
    <div style="display:flex;gap:10px;align-items:center; flex-wrap:wrap;">
      <label class="switch"><input id="toggleOutliers" type="checkbox" /> Ocultar outliers</label>
      
      <div id="outliersMini" class="small-muted" style="margin-left:12px"></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="resetZoomBtn" class="btn-ghost">Resetar Zoom</button>
      <div class="small-muted">Top <select id="topN" class="input" style="width:70px"><option>10</option><option selected>15</option><option>20</option><option>50</option></select></div>
    </div>
  </div>
  
  <div class="card full-width">
    <h4>An√°lise R√°pida por Ano</h4>
    <div id="yearFilterContainer">
      <p class="small-muted" style="margin: 0; padding: 5px;">Carregue o CSV para ver os anos.</p>
    </div>
  </div
  >
  <section class="card full-width">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4>Evolu√ß√£o Di√°ria</h4>
      <div class="small-muted">Clique em um ponto para filtrar</div>
    </div>
    <div class="chart-wrap" style="height:420px;"><canvas id="dailyChart"></canvas></div>
    <div id="outliersList" class="small-muted hidden"></div>
  </section>

  <section class="card full-width" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4>Evolu√ß√£o Mensal (Fluxo de Caixa)</h4>
      <div class="small-muted">Zoom com Ctrl + Scroll</div>
    </div>
    <div class="chart-wrap" style="height:420px;">
      <canvas id="monthChart"></canvas>
    </div>
  </section>

  <section class="card full-width">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4>Top Destinat√°rios / Fontes (Saldo L√≠quido)</h4>
      <div class="small-muted">Mostrando <span id="topCount">15</span></div>
    </div>
    <div class="chart-wrap" style="height:340px"><canvas id="barChart"></canvas></div>
  </section>

  <section class="card full-width">
    <h4>Insights 2.0 ‚Äî Intelig√™ncia Financeira</h4>
    <div class="insights-grid" id="insightsContainer" style="margin-top:12px;">
      </div>
  </section>

  <section class="card full-width" style="margin-top:12px; padding-bottom: 10px;">
    <div id="aliasEditorHeader" class="accordion-header" style="cursor:pointer;">
      <h4>Editor de Aliases (Nomes)</h4>
      <span id="aliasEditorIcon" class="accordion-icon" style="padding: 12px 14px;">‚ñ∂</span>
    </div>
    <div id="aliasEditorContent" class="accordion-content">
      <p class="small-muted" style="margin-top:4px; padding: 0 14px;">Edite o JSON abaixo para agrupar nomes. Clique duplo no acorde√£o √© um atalho.</p>
      <textarea id="nameAliasesEditor" style="margin-top:12px; margin-bottom:10px;"></textarea>
      <button id="saveAliasesBtn" class="btn" style="margin-left: 14px;">Salvar Aliases</button>
      <button id="exportBackupBtn" class="btn-ghost" style="margin-left: 8px;">Exportar Backup</button>
      <button id="importBackupBtn" class="btn-ghost" style="margin-left: 8px;">Importar Backup</button>
    </div>
  </section>

  <section class="card full-width" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center; flex-wrap: wrap; gap: 10px;">
      <h4>Detalhes das Transa√ß√µes</h4>
      
      <input id="accordionSearch" class="input" placeholder="Buscar em detalhes..." style="flex: 1; min-width: 200px; margin-left: auto;">

      <div style="display:flex; gap:12px; align-items:center; font-size:14px; flex-wrap:wrap;">
          <label class="switch" title="Agrupa transa√ß√µes desconhecidas (sem alias) em 'Outros Gastos'">
              <input type="checkbox" id="groupUnknownToggle" /> Agrupar desconhecidos
          </label>

          <label class="switch" title="Mostrar/Ocultar transfer√™ncias internas (entre suas pr√≥prias contas)">
              <input type="checkbox" id="showIgnoredToggle" /> Exibir ignorados
          </label>
      </div>

      <button id="bulkMoveBtn" class="btn" style="display: none; padding: 8px 12px; font-size: 14px;">
          Mover <span id="bulkCount">0</span> Selecionadas
      </button>

      <div style="display:flex; gap:10px; align-items:center;">
        <span class="small-muted">Ordenar por:</span>
        <select id="accordionSort" class="input" style="padding-top:6px; padding-bottom:6px;">
          <option value="count" selected>Quantidade</option>
          <option value="name">Alfab√©tica</option>
          <option value="credit_desc">Maior Cr√©dito</option>
          <option value="credit_asc">Menor Cr√©dito</option>
          <option value="debit_desc">Maior D√©bito</option>
          <option value="debit_asc">Menor D√©bito</option>
        </select>
      </div>
      <div class="small-muted" style="width: 100%; text-align: right;">Clique duplo no nome para editar. Clique na <span style="color: var(--red);">‚óè</span> para ocultar.</div>
    </div>
    <div id="accordionContainer" class="accordion-wrap" style="margin-top:12px;">
      </div>
    <button id="accordionLoadMore" class="btn-ghost" style="width: 100%; margin-top: 12px; display: none;">Ver mais</button>
  </section>


  <div id="footer" class="footer-bar">
    <div id="footerLeft">Per√≠odo exibido: ‚Äî</div>
    <div id="footerRight">Total: R$ 0,00 ‚Ä¢ Transa√ß√µes: 0</div>
  </div>
</div>

<div id="moveTxModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000;">
    <div style="background: var(--card); border: 1px solid var(--glass); border-radius: 12px; padding: 20px; width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        <h4 style="margin-top: 0; margin-bottom: 15px;">Mover Transa√ß√£o para Grupo</h4>
        <p class="small-muted" id="txMoveHistDisplay" style="margin-bottom: 10px;"></p>
        
        <label for="groupNameInput" class="small-muted">Enviar para que grupo? (digite o nome)</label>
        <input id="groupNameInput" type="text" class="input" style="width: 100%; margin-top: 5px; margin-bottom: 5px;" placeholder="Nome do Grupo" autocomplete="off"/>
        
        <div id="autocompleteList" style="max-height: 150px; overflow-y: auto; background: var(--panel); border-radius: 6px; margin-bottom: 15px; display: none; border: 1px solid var(--glass);"></div>
        
        <label class="switch" style="font-size: 14px; margin-bottom: 15px; display: block;">
            <input id="saveAliasCheckbox" type="checkbox" /> Salvar como alias para futuros?
        </label>
        
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button id="cancelMoveBtn" class="btn-ghost">Cancelar</button>
            <button id="confirmMoveBtn" class="btn">Mover</button>
        </div>
    </div>
</div>


<script>
/* ---- genTxId (determin√≠stico) ---- */
function genTxId(tx){
  const s = `${tx.dateISO||''}|${tx.credit||0}|${tx.debit||0}|${(tx.hist||'').replace(/\s+/g,' ').trim().toLowerCase()}`;
  let h = 5381;
  for (let i = 0; i < s.length; i++) h = ((h << 5) + h) + s.charCodeAt(i);
  return 'tx_' + (h >>> 0).toString(36);
}

/* ---- Ignored transactions persistence (CONSOLIDADO) ---- */
function loadIgnoredTransactions(){
  try { return new Set(JSON.parse(localStorage.getItem('fin_v5_ignored_tx') || '[]')); }
  catch(e){ return new Set(); }
}
function saveIgnoredTransactions(set){
  try { localStorage.setItem('fin_v5_ignored_tx', JSON.stringify(Array.from(set))); }
  catch(e){ console.error('saveIgnoredTransactions failed', e); }
}
let ignoredTransactions = loadIgnoredTransactions();
let selectedTransactions = new Set(); // Para sele√ß√£o em massa

</script>


<script>
/* ===========================
   Helpers & State
   =========================== */

// Refer√™ncias corrigidas e completas
const fileInput = document.getElementById('fileInput'); // ADICIONADO
const statusIcon = document.getElementById('statusIcon'); // ADICIONADO
const fileInputLabel = document.getElementById('fileInputLabel'); 
const exportBackup = document.getElementById('exportBackup'); 
const importBackup = document.getElementById('importBackup'); 
const printScreen = document.getElementById('printScreen'); 
// Elementos inexistentes no HTML, mas mantidos por compatibilidade com o JS original, ou renomeados
const searchName = document.getElementById('accordionSearch'); // RE-MAPEAR para busca do acorde√£o
const dateFrom = document.getElementById('dateFrom') || {value:''}; // Mock se n√£o existir
const dateTo = document.getElementById('dateTo') || {value:''}; // Mock se n√£o existir
const applyDate = document.getElementById('applyDate'); // N√£o existe no HTML, mas existia no JS de EduBiru
const clearFilters = document.getElementById('clearFilters'); // N√£o existe no HTML, mas existia no JS de EduBiru
const topN = document.getElementById('topN');
const toggleOutliers = document.getElementById('toggleOutliers');
const outliersListEl = document.getElementById('outliersList');
const outliersMini = document.getElementById('outliersMini');
const resetZoomBtn = document.getElementById('resetZoomBtn');
const themeToggle = document.getElementById('themeToggle');
const insightsContainer = document.getElementById('insightsContainer');
const nameAliasesEditor = document.getElementById('nameAliasesEditor');
const saveAliasesBtn = document.getElementById('saveAliasesBtn');
const yearFilterContainer = document.getElementById('yearFilterContainer');
const accordionSearch = document.getElementById('accordionSearch');
const accordionSort = document.getElementById('accordionSort');


// Toggles movidos para o bloco de controles principal
const groupUnknownToggle = document.getElementById('groupUnknownToggle');
const showIgnoredToggle = document.getElementById('showIgnoredToggle');

// Elementos do novo modal (CONSOLIDADO)
const moveTxModal = document.getElementById('moveTxModal');
const groupNameInput = document.getElementById('groupNameInput');
const saveAliasCheckbox = document.getElementById('saveAliasCheckbox');
const confirmMoveBtn = document.getElementById('confirmMoveBtn');
const cancelMoveBtn = document.getElementById('cancelMoveBtn');
const txMoveHistDisplay = document.getElementById('txMoveHistDisplay');
const autocompleteList = document.getElementById('autocompleteList');
const bulkMoveBtn = document.getElementById('bulkMoveBtn');
const bulkCount = document.getElementById('bulkCount');


let rawRows = []; // merged parsed rows
let filtered = []; // after filter by date/name
let nameMap = {}; // canonical -> displayName
let hideOutliers = false; // default off
let hiddenGroups = new Set(); // NOVO: Grupos para ocultar dos gr√°ficos
let shouldGroupUnknown = false; // Controlado pelo groupUnknownToggle
let shouldShowIgnored = false; // Controlado pelo showIgnoredToggle

// Vari√°vel de estado para o modal
let currentTxIdToMove = null;


// NOVO: nomes ignorados (din√¢mico ap√≥s agrega√ß√£o)
let IGNORED_GROUP_NAMES = new Set();

// Vari√°veis globais de agrega√ß√£o (para performance)
let aggArr = [];
let accordionAggArr = []; // NOVO: Lista separada para o acorde√£o
let accordionSortOrder = 'count'; // NOVO: Estado de Sorteio
let accordionPageSize = 20; // NOVO: Estado de Pagina√ß√£o

let dayAgg = new Map(); // MUDAN√áA: Usar Map
let monthIn = {};
let monthOut = {};
let outlierIndexes = [];
let globalTotalIn = 0;
let globalTotalOut = 0;
let globalSaldo = 0;
let availableYears = []; // NOVO: Anos dispon√≠veis no CSV

// Gr√°ficos globais
let chartDaily = null;
let barChart = null;
let chartMonthly = null;


// invest ignore regex (robust)
const IGNORE_INVEST_REGEX = /invest[\s\w]*facil|saldo invest|apl\.?invest|resgate inv|rent[\.\s]?inv|investfacil/i;

// NOVO: regex para detectar grupos "internos" (transfer√™ncias pr√≥prias)
const INTERNAL_NAME_REGEX = [
  /carlos eduardo/i,
  /o propr[i√≠]o favorecido/i,
  /mesma titularidade/i,
  /carlos costa/i,
  /eduardo costa/i,
  /pag\*carloseduardo/i,
  /visa electron/i
];

// helper: remove accents
function removeAccents(s){
  return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}
function normUpper(s){ return (s||'').toString().toUpperCase(); }

/* ======================================================
   ATUALIZA√á√ÉO GIGANTE (10/30) - L√ìGICA DE NOMES
   ====================================================== */

// Lista de prefixos gen√©ricos (A "Faxina")
// Esta lista √© "gentil" e remove APENAS prefixos, preservando os nomes.
const GENERIC_PREFIXES = [
  // Tipos de Transa√ß√£o (Gen√©ricos)
  'pix', 'ted', 'doc', 'transf(erencia)?', 'transfe', 'transf', 'pagto', 'dep(\\\.)?', 'deposito', 'saq',
  
  // Lixo de Banco (Remetente/Destinat√°rio)
  'remetente', 'remet', 'remt', 'rem', 'destinatario', 'dest', 'des', 'rem:', 'dest:', 'des:', 'remet\\.',
  
  // Lixo de Banco (Tipos Espec√≠ficos - MAIS LONGOS PRIMEIRO)
  'visa electron \\| ', // <-- CORRIGIDO (com espa√ßo no final)
  'pag\\*carloseduardo', // O outro
  'pag\\*', // Gen√©rico
  'ted t elet disp remet',
  'ted t elet disp', 
  'ted dif titul', 
  'devolucao pix',
  'pix qrcode est', 
  'pix qrcode din des e rem', 
  'pix qrcode din',
  'qrcode din', // <-- NOVO
  'transfe pix rem', 
  'pix saque des',
  'saque din atm', 
  'saque din',
  'dep din atm ag', 
  'dep din atm',
  'trans sal p c c', 
  'trans sal', 
  'cc bdn', 
  'bdn',
  'autoriza(cao|c)?', // <-- MELHORADO (pega autoriz, autoriza, autorizacao)
  
  // Lixo de Contas (MAIS LONGOS PRIMEIRO)
  'pague facil recarga pre pago',
  'conta telefone bradesco c vivo rs',
  'conta de luz bradesco c ceee d rs',
  'conta de luz bradesco c cpfl sp',
  'pgto elet trib bradesco c detran gade e rs',
  'deb automatico',
  'tarifa bancaria vr parcial pix saque troco', 
  'tarifa bancaria',
  'cobranca santander', 
  'cobranca acordo', 
  'cobranca itaucard',
  'cobranca', // Gen√©rico
  'cia riograndense de s',
  'oper serv hoteleiros ltda',
  'hoteleiros ltda',
  
  // Lixo do "Trans Sal" (Item 3)
  'bco age cta' // <-- NOVO
];// Cria uma regex √∫nica que encontra esses prefixos no in√≠cio da string ou ap√≥s um separador
const NOISE_REGEX = new RegExp(`(^|[\\|\\s])(${GENERIC_PREFIXES.join('|')})\\b`, 'ig');


// "Faxina Geral" - Fun√ß√£o de Limpeza de Nomes
function cleanRawName(s){
  if(!s) return '';
  s = s.toString();
  
  // 1. Remove os prefixos gen√©ricos (definidos acima)
  s = s.replace(NOISE_REGEX, ' '); 
  
  // 2. O resto da limpeza (remover separadores, c√≥digos num√©ricos, espa√ßos extras)
  s = s.replace(/[\|\(\)\:\*]+/g,' ');
  s = s.replace(/\b(?!99app\b|99pay\b|aydem\b)[a-z]*\d+[a-z\d]*\b/ig, ' '); // Remove c√≥digos (MAS PRESERVA 99, Aydem)
  s = s.replace(/\s+/g,' ').trim();
  return s;
}


/* JSON de Aliases (As Regras) ‚Äî embutido (substitua/complete conforme backup) */
// [CORRE√á√ÉO CR√çTICA]: Mudado para 'let' para permitir reatribui√ß√£o ao carregar/salvar/importar
let NAME_ALIASES = {
  // Pessoas (Chaves limpas)
  'maria inez': 'Maria Inez dos Santos Cal√ßada',
  'maria inez dos santos': 'Maria Inez dos Santos Cal√ßada',
  'maria inez dos santos calcada': 'Maria Inez dos Santos Cal√ßada',
  'inez dos santos': 'Maria Inez dos Santos Cal√ßada',
  'inez dos santos calca': 'Maria Inez dos Santos Cal√ßada',
  
  'carlos eduardo': 'Carlos Eduardo Cal√ßada',
  'carlos eduardo calcada': 'Carlos Eduardo Cal√ßada',
  'carlos eduardo calcad': 'Carlos Eduardo Cal√ßada',
  
  'ana paula calcada': 'Ana Paula Cal√ßada Pereira',
  'ana paula calcada pereira': 'Ana Paula Cal√ßada Pereira',
  'ana paula calcada pereir': 'Ana Paula Cal√ßada Pereira',

  'angelo calcada': 'Angelo Cal√ßada Pereira',
  'angelo calcada pereira': 'Angelo Cal√ßada Pereira',

  'fabio ricardo trindad': 'F√°bio Ricardo Trindade',
  
  'lucas jesus da silva arruiz': 'Lucas Jesus da Silva',
  'lucas jesus da silva': 'Lucas Jesus da Silva',
  'lucas jesus d': 'Lucas Jesus da Silva',
  'lucas jesus da silva e afins': 'Lucas Jesus da Silva', // <-- ADICIONE ESTA LINHA

  'alexsander tarouco l': 'Alexsander Tarouco',
  'luiza silveira perei': 'Luiza Silveira Pereira',
  'cristina dos santos b': 'Cristina dos Santos',
  
  'ewerton': 'Ewerton Adilson Valente Machado',
  'ewerton adilson valente machado': 'Ewerton Adilson Valente Machado',

  // Apostas e Jogos
  'hs do brasil ltda': 'Apostas e Jogos',
  'kaizen gaming brasil': 'Apostas e Jogos',
  'betmgm': 'Apostas e Jogos',
  'betnacional': 'Apostas e Jogos',

  // Movimenta√ß√µes em Dinheiro
  'saque e pague r': 'Movimenta√ß√µes em Dinheiro',

  // Bancos e Cart√µes
  'caixa economica fede': 'Caixa Econ√¥mica Federal',
  'itaucard': 'Cart√µes e Bancos',
  'tricard': 'Cart√µes e Bancos',

  // Sal√°rios
  'oper serv hoteleiros ltda': 'Sal√°rios',

  // Operadoras
  'vivo rs': 'Operadoras',
  'tim': 'Operadoras',
  'vivo': 'Operadoras',
  'claro': 'Operadoras',
  'oi': 'Operadoras',
  'vetorialnet informatica e servic': 'Operadoras',
  'vetorialnet': 'Operadoras',
  'netflix com': 'Operadoras',

  // Consumo e Servi√ßos
  'ceee d rs': 'Consumo e Servi√ßos',
  'ceee': 'Consumo e Servi√ßos',
  'corsan': 'Consumo e Servi√ßos',
  'cpfl sp': 'Consumo e Servi√ßos',
  'cpfl': 'Consumo e Servi√ßos',
  'agua': 'Consumo e Servi√ßos',
  'luz': 'Consumo e Servi√ßos',
  'internet': 'Consumo e Servi√ßos',
  'sanasa': 'Consumo e Servi√ßos',
  'tv mae': 'Consumo e Servi√ßos',

  // Impostos e Tributos
  'detran gade e rs': 'Impostos e tributos',
  'detran': 'Impostos e tributos',
  'tarifas': 'Impostos e tributos',
  'tributos': 'Impostos e tributos',

  // Outros
  'mercadopago':'Mercado Pago',
  'o proprio favorecido':'O pr√≥prio favorecido',
  'supermercado guanabara':'Supermercado Guanabara',
  'dimed':'Farm√°cias Panvel',
  'panvel': 'Farm√°cias Panvel',
  'drogasil': 'Drogasil',
  'raia': 'Drogasil',
  'iugu': 'Iugu',
  'paypal do brasil': 'Paypal do Brasil',
  'paypal do brasi': 'Paypal do Brasil',
  'juliana reis rodrigue': 'Juliana Reis Rodrigues',
  'juliana reis rodrigu': 'Juliana Reis Rodrigues',
  'juliana reis rodrigues me': 'Juliana Reis Rodrigues',
  'juliana reis rodr': 'Juliana Reis Rodrigues',
  'juliana reis rodrigues': 'Juliana Reis Rodrigues',
  'uber': 'Uber',
  'uber do brasil tecnol': 'Uber',
  'uber uber trip': 'Uber',
  'uber trip helpuber': 'Uber',
  'uberbr uber trip hel': 'Uber',
  'uber do brasil tecno': 'Uber',
  'uber do brasil tecnologia': 'Uber'
  // adicionar mais entradas do backup se necess√°rio
};


function canonicalKey(cleanName){
  if(!cleanName) return '';
  // CORRE√á√ÉO: Recebe o nome j√° limpo
  let s = removeAccents(cleanName).toLowerCase();
  s = s.replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim();
  return s;
}

function capitalizeWords(s){
  // CORRE√á√ÉO: L√≥gica para n√£o capitalizar palavras de liga√ß√£o
  const lowers = ['da', 'de', 'do', 'dos', 'das', 'e'];
  return s.split(' ').map(w => {
    if (!w) return '';
    const lowerW = w.toLowerCase();
    if (lowers.includes(lowerW)) return lowerW;
    // For√ßa o resto para min√∫sculo para casos como "LTDA"
    return w[0].toUpperCase() + w.slice(1).toLowerCase(); 
  }).join(' ');
}


function normalizeAndMapName(raw, existingMap){
  existingMap = existingMap || {};
  
  // 1. Limpa o nome cru (mant√©m acentos e caixa original)
  const cleanName = cleanRawName(raw);
  
  // 2. Cria a chave de agrupamento (sem acento, min√∫scula)
  const key = canonicalKey(cleanName); // ATUALIZADO: Usa o NOME LIMPO para a chave
  if(!key) return '';

  // 3. Checa o editor de Aliases (prioridade m√°xima)
  if(NAME_ALIASES[key]) return NAME_ALIASES[key];
  
  // 4. Checa se essa chave j√° foi mapeada
  if(existingMap[key]) return existingMap[key];

  // 5. Tenta o fuzzy match (usando o cleanName para a chave)
  for(const k in NAME_ALIASES){
      if(!k) continue;
      // Se a chave limpa (key) cont√©m uma chave de alias (k)
      // Ex: key "posto shell 123" cont√©m k "posto shell"
      if(key.includes(k)) return NAME_ALIASES[k];
  }
  for(const k in existingMap){
    if(!k) continue;
    if(k === key || k.startsWith(key) || key.startsWith(k)){
       existingMap[key] = existingMap[k];
       return existingMap[k];
    }
  }
  
  // NOVO: L√≥gica do Checkbox "Anti-Trabalho"
  // Se n√£o achou regra E o checkbox est√° marcado...
  if (shouldGroupUnknown) {
    return 'Outros Gastos'; // Agrupa em "Outros Gastos"
  }

  // 6. Novo nome: Capitaliza o NOME LIMPO (com acentos), n√£o a CHAVE
  const displayName = cleanName.replace(/\b\d+\b/g, ' ').replace(/\s+/g, ' ').trim();
  // Se o nome limpo for muito curto ou vazio, usa a chave (fallback)
  if (displayName.length < 2) {
    const fallbackDisplay = capitalizeWords(key); // Usa a chave 'key' (que √© o cleanName)
    existingMap[key] = fallbackDisplay;
    return fallbackDisplay;
  }
  
  const display = capitalizeWords(displayName); 
  existingMap[key] = display;
  return display;
}

/* ===== Outlier detection (IQR) ===== */
function detectOutliersIQR(values, multiplier=1.5){
  const arr = values.map(v=> isFinite(v)? Number(v): NaN).filter(v=> !isNaN(v)).sort((a,b)=>a-b);
  if(arr.length < 4) return values.map(_=> false);
  const q1 = arr[Math.floor((arr.length-1)*0.25)];
  const q3 = arr[Math.floor((arr.length-1)*0.75)];
  const iqr = q3 - q1;
  const lower = q1 - multiplier*iqr;
  const upper = q3 + multiplier*iqr;
  return values.map(v => (v < lower || v > upper));
}

/* ===== utilities ===== */
// NOVO: Fun√ß√£o para pegar cores do CSS (para funcionar com temas)
function getCssVar(varName) {
  return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
}

function fmt(v){ return 'R$ '+ Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2}); }

// CORRE√á√ÉO FINAL: parseBRNumber robusto
function parseBRNumber(s){
  if(s==null) return 0;
  let str = s.toString()
    .replace(/"/g,'')      // Remove aspas
    .replace("R$", "")      // Remove 'R$'
    .replace(/\s/g, "")    // Remove espa√ßos
    .replace(/\./g, "")    // Remove pontos de milhar
    .replace(",", ".");    // Troca v√≠rgula decimal

  // Lida com n√∫meros negativos (ex: "(100.00)" ou "-100.00")
  const isNegative = str.includes('(') || str.startsWith('-');
  str = str.replace(/[\(\)-]/g, ""); // Remove par√™nteses e sinal
  
  const n = parseFloat(str);
  if (isNaN(n)) return 0;
  
  return isNegative ? -n : n;
}

function tryParseDateLabel(lbl){
  // lbl like dd/mm/yy or dd/mm/yyyy
  if(!lbl) return null;
  const parts = lbl.split('/');
  if(parts.length<3) return null;
  let d = parseInt(parts[0],10), m = parseInt(parts[1],10), y = parts[2];
  if(y.length === 2) y = '20'+y;
  y = parseInt(y,10);
  const dateObj = new Date(y, m-1, d);
  return isNaN(dateObj.getTime()) ? null : dateObj;
}
// NOVO: Debounce para performance
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}


/* ===========================
   CSV parse & merge logic
   =========================== */

function parseCSVFile(file, encoding='utf-8'){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e => {
      try {
        let text = e.target.result || '';
        text = text.replace(/^\uFEFF/, '');
        text = text.replace(/\uFFFD/g,' ');
        const raw = text.split(/\r?\n/).map(l=> l.replace(/\u0000/g,''));
        const trimmed = raw.map(l=> l.trim());
        // find header line (must contain ';' and DATA and HIST)
        let headerLineIndex = trimmed.findIndex(l=>{
          const line = normUpper(l||'');
          return line.includes(';') && line.includes('DATA') && (line.includes('HIST') || line.includes('HISTOR'));
        });
        if(headerLineIndex === -1){
          // fallback: find explicit 'EXTRATO' then next line with ';'
          const poss = trimmed.findIndex(l=> normUpper(l).includes('EXTRATO'));
          if(poss!==-1 && trimmed[poss+1] && trimmed[poss+1].includes(';')) headerLineIndex = poss+1;
        }
        if(headerLineIndex === -1){
          return reject(new Error('Cabe√ßalho n√£o encontrado'));
        }

        let headerLine = raw[headerLineIndex] || trimmed[headerLineIndex];
        // split and remove empty trailing columns
        const sep = ';';
        // CORRE√á√ÉO: N√£o filtrar colunas vazias do cabe√ßalho para manter o alinhamento
        const headers = headerLine.split(sep).map(h=>h.trim());
        const ids = detectIndices(headers);

        // NOVO: Valida√ß√£o M√≠nima dos √çndices
        // Se n√£o encontrar os cabe√ßalhos essenciais, rejeita a promessa
        // para acionar o fallback de encoding (UTF-8) no listener do bot√£o.
        if (ids.dataIdx === -1 || ids.creditIdx === -1 || ids.debitIdx === -1) {
            console.error(`Falha ao detectar cabe√ßalhos com encoding ${encoding}.`, ids);
            // Retorna um erro para acionar o fallback
            return reject(new Error(`Cabe√ßalhos essenciais (Data, Cr√©dito, D√©bito) n√£o encontrados com encoding ${encoding}.`));
        }

        const dataLines = raw.slice(headerLineIndex+1);

        const rows = [];
        for(let i=0;i<dataLines.length;i++){
          // CORRE√á√ÉO: N√£o remover mais o trailing semicolon, deixa o split lidar com isso
          let l = dataLines[i]; // .replace(/;+$/,'');
          // ignore empty lines
          if(!l || l.trim()==='') continue;
          const cols = l.split(sep);
          // some continuation lines start with ';' and have only rem/dest info -> keep for merging
          const obj = {};
          headers.forEach((h,idx)=> obj[h] = (cols[idx]||'').trim());
          rows.push(obj);
        }

        // Merge continuation lines: if a row has no date, append its hist to previous hist.
        const hDate = headers[ids.dataIdx], hHist = headers[ids.histIdx];
        const merged = [];
        for(let i=0;i<rows.length;i++){
          const r = rows[i];
          const hasDate = r[hDate] && r[hDate].toString().trim() !== '';
          if(!hasDate){
            if(merged.length>0){
              const last = merged[merged.length-1];
              const add = (r[hHist]||'').toString().trim();
              if(add) last[hHist] = last[hHist] ? (last[hHist] + ' | ' + add) : add;
            }
            continue;
          } else {
            const hvRaw = (r[hHist]||'').toString();
            const hv = normUpper(hvRaw);
            if(hv.includes('SALDO ANTERIOR')) continue;
            if(IGNORE_INVEST_REGEX.test(hv)) continue;
            merged.push(r);
          }
        }

        // convert merged to processed objects
        const processed = merged.map(r=>{
          const dateRaw = (r[hDate]||'').toString().trim();
          // normalize date formats like dd/mm/yy or dd/mm/yyyy
          let parts = dateRaw.split('/');
          let day=null,month=null,year=null;
          if(parts.length>=3){
            day = parts[0].padStart(2,'0'); month = parts[1].padStart(2,'0'); year = parts[2];
            // CORRE√á√ÉO: L√≥gica de data (yy -> yyyy)
            if(year.length===2) year = '20'+year;
          }
          const dateISO = (year && month && day) ? `${year}-${month}-${day}` : '';

          // CORRE√á√ÉO: A l√≥gica de `parseBRNumber` j√° trata o sinal.
          // Aqui garantimos que os valores sejam lidos como est√£o.
          const credit = parseBRNumber(r[headers[ids.creditIdx]]||'0');
          const debit = parseBRNumber(r[headers[ids.debitIdx]]||'0');

          const docto = (r[headers[ids.doctoIdx]]||'').toString().trim();
          const hist = (r[headers[ids.histIdx]]||'').toString().trim();
          
          const tx = {
            date: dateISO ? dateISO.split('-').reverse().join('/') : '', // DD/MM/YYYY string (para exibi√ß√£o)
            dateISO: dateISO, // AAAA-MM-DD string (para Charts)
            dateObj: dateISO ? new Date(dateISO) : null, // MUDAN√áA: Use a string ISO (mais robusta)
            hist, docto,
            credit, // Pode ser positivo
            debit,  // Pode ser negativo ou positivo, dependendo do CSV
            raw: r
          };
          // ensure deterministic txId
          tx.txId = tx.txId || genTxId(tx);
          return tx;
        });

        // REMOVIDO: filtro antigo que descartava transa√ß√µes internas
        rawRows = processed; // mant√©m lista completa
        resolve(processMerged(headers, ids, processed));

      } catch(err){
        reject(err);
      }
    };
    reader.onerror = err => reject(err);
    reader.readAsText(file, encoding); // try reading bradesco exports tolerant encoding
  });
}

// detect indices for common headers
// CORRE√á√ÉO: detectIndices mais robusto
function detectIndices(headers){
  const hUp = headers.map(h=> normUpper(removeAccents(h||''))); // Remove acentos
  
  // Busca exata primeiro (comum no CSV "original" e "excel")
  let dataIdx = hUp.findIndex(h=> h === 'DATA');
  let histIdx = hUp.findIndex(h=> h === 'HISTORICO');
  let creditIdx = hUp.findIndex(h=> h === 'CREDITO (R$)');
  let debitIdx = hUp.findIndex(h=> h === 'DEBITO (R$)');

  // Fallback (busca parcial)
  if (dataIdx === -1) dataIdx = hUp.findIndex(h=> h.includes('DATA'));
  if (histIdx === -1) histIdx = hUp.findIndex(h=> h.includes('HIST'));
  // CORRE√á√ÉO: Fallback mais agressivo para cr√©dito/d√©bito
  if (creditIdx === -1) creditIdx = hUp.findIndex(h=> h.includes('CRED'));
  if (debitIdx === -1) debitIdx = hUp.findIndex(h=> h.includes('DEB'));
  
  const doctoIdx = hUp.findIndex(h=> h.includes('DOCT') || h.includes('DOC'));
  const salIdx = hUp.findIndex(h=> h.includes('SALD'));
  
  return { dataIdx, histIdx, doctoIdx, creditIdx, debitIdx, salIdx };
}


/* ===========================
   Processing + rendering
   =========================== */

function processMerged(headers, ids, processed){
  // store rawRows already set
  // apply initial filters (no filters = all)
  filtered = processed.slice(); // copy
  // default: remove any rows without date
  filtered = filtered.filter(r=> r.dateObj);
  
  // NOVO: Coleta os anos dispon√≠veis antes de qualquer filtro
  const years = new Set();
  filtered.forEach(r => {
    if (r.dateObj && !isNaN(r.dateObj.getFullYear())) { // CORRE√á√ÉO: Verifica se o ano √© v√°lido
      years.add(r.dateObj.getFullYear().toString());
    }
  });
  availableYears = Array.from(years).sort();
  renderYearFilters(availableYears); // NOVO: Renderiza os cards de ano

  // show counts
  document.getElementById('footerRight').textContent = `Total: R$ 0,00 ‚Ä¢ Transa√ß√µes: ${filtered.length}`;
  updateAll();
  return { ok:true };
}

// NOVO: Renderiza os cards de ano (CONSOLIDADO)
function renderYearFilters(years) {
  yearFilterContainer.innerHTML = '';
  if (years.length === 0) {
    yearFilterContainer.innerHTML = '<p class="small-muted" style="margin: 0; padding: 5px;">Carregue o CSV para ver os anos.</p>';
    return;
  }
  years.forEach(year => {
    const card = document.createElement('div');
    card.className = 'year-card';
    card.textContent = year;
    card.dataset.year = year;
    card.addEventListener('click', (e) => {
      const isActive = e.target.classList.contains('active');
      if (isActive) {
        clearYearFilterState(); // Usa a fun√ß√£o nova
        updateAll(); // Re-renderiza tudo (sem filtros)
      } else {
        applyYearFilter(year);
      }
    });
    yearFilterContainer.appendChild(card);
  });
}

// NOVO: Aplica o filtro de ano (CONSOLIDADO)
function applyYearFilter(year) {
  const yearStr = year.toString();
  // 1. Define as datas do filtro
  dateFrom.value = `${yearStr}-01-01`;
  dateTo.value = `${yearStr}-12-31`;
  
  // 2. Remove o estado ativo de todos os cards
  yearFilterContainer.querySelectorAll('.year-card').forEach(card => {
    card.classList.remove('active');
  });

  // 3. Ativa o card clicado
  yearFilterContainer.querySelector(`[data-year="${yearStr}"]`).classList.add('active');

  // 4. Aplica o filtro
  updateAll();
}

// NOVO: Remove filtro de ano (chamado em clearFilters/click no card ativo) (CONSOLIDADO)
function clearYearFilterState() {
  dateFrom.value = '';
  dateTo.value = '';
  yearFilterContainer.querySelectorAll('.year-card').forEach(card => card.classList.remove('active'));
}


// NOVO: Salva filtros no localStorage
function saveFilters() {
  const filters = {
    search: accordionSearch.value,
    from: dateFrom.value,
    to: dateTo.value,
    top: topN.value,
    hideOutliers: toggleOutliers.checked,
    groupUnknown: groupUnknownToggle.checked, // USANDO NOVO ID
    showIgnored: showIgnoredToggle.checked // USANDO NOVO ID
  };
  localStorage.setItem('fin_v5_filters', JSON.stringify(filters));
}

// NOVO: Carrega filtros do localStorage
function loadFilters() {
  const filters = JSON.parse(localStorage.getItem('fin_v5_filters') || '{}');
  if(accordionSearch) accordionSearch.value = filters.search || '';
  dateFrom.value = filters.from || '';
  dateTo.value = filters.to || '';
  topN.value = filters.top || '15';
  if(toggleOutliers) toggleOutliers.checked = filters.hideOutliers || false;
  
  // Define os toggles no acorde√£o (USANDO NOVOS IDS)
  if(groupUnknownToggle) groupUnknownToggle.checked = filters.groupUnknown || false;
  if(showIgnoredToggle) showIgnoredToggle.checked = filters.showIgnored || false; 
  
  // Seta as vari√°veis globais imediatamente
  hideOutliers = toggleOutliers ? toggleOutliers.checked : (filters.hideOutliers || false);
  shouldGroupUnknown = groupUnknownToggle ? groupUnknownToggle.checked : (filters.groupUnknown || false);
  shouldShowIgnored = showIgnoredToggle ? showIgnoredToggle.checked : (filters.showIgnored || false);
  
  // NOVO: Carrega grupos ocultos
  const hidden = JSON.parse(localStorage.getItem('fin_v5_hidden_groups') || '[]');
  hiddenGroups = new Set(hidden);
}

// NOVO: Carrega Aliases do localStorage
function loadNameAliases() {
  const savedAliases = localStorage.getItem('fin_v5_aliases');
  if (savedAliases) {
    try {
      NAME_ALIASES = JSON.parse(savedAliases);
    } catch (e) {
      console.error("Erro ao carregar aliases salvos:", e);
      // Carrega os padr√µes se o JSON salvo estiver corrompido
      localStorage.setItem('fin_v5_aliases', JSON.stringify(NAME_ALIASES, null, 2));
    }
  }
  if(nameAliasesEditor) nameAliasesEditor.value = JSON.stringify(NAME_ALIASES, null, 2);
}

// NOVO: Salva Aliases no localStorage
function saveNameAliases() {
  try {
    const newAliases = JSON.parse(nameAliasesEditor.value);
    NAME_ALIASES = newAliases; // Atualiza a vari√°vel global
    localStorage.setItem('fin_v5_aliases', JSON.stringify(NAME_ALIASES, null, 2));
    // AUTO-DOWNLOAD do aliases salvo (gera backup automaticamente)
    try {
      const key = 'fin_v5_aliases';
      const data = localStorage.getItem(key);
      const blob = new Blob([data], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `financas_biru_aliases_backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    } catch(e) { console.error('auto-download failed', e); }
    alert("Aliases salvos com sucesso! O painel ser√° atualizado.");
    updateAll(); // Re-processa tudo com os novos aliases
  } catch (e) {
    // [ERRO AQUI] Se o JSON for inv√°lido, o erro ser√° capturado
    alert("Erro ao salvar: O JSON √© inv√°lido. Verifique a sintaxe.\n\n" + e.message);
  }
}


function updateAll(){
  // Atualiza as vari√°veis globais a partir dos toggles antes de agregar
  shouldGroupUnknown = groupUnknownToggle ? groupUnknownToggle.checked : shouldGroupUnknown;
  shouldShowIgnored = showIgnoredToggle ? showIgnoredToggle.checked : shouldShowIgnored;

  applyFilters();       // 1. Aplica filtros
  buildAggregations();  // 2. Processa dados
  renderSummary();      // 3. Renderiza componentes
  renderDaily();
  renderTop();
  renderInsights();
  renderMonthly();
  renderAccordion();
  updateBulkMoveButton(); // Atualiza o bot√£o de a√ß√£o em massa
}


function applyFilters(){
  // name search
  const q = (accordionSearch.value||'').toLowerCase().trim();
  let rows = rawRows.slice();
  // date filter
  const from = parseDateInput(dateFrom.value);
  const to = parseDateInput(dateTo.value);
  if(from || to){
    rows = rows.filter(r=>{
      if(!r.dateObj) return false;
      const t = r.dateObj.getTime();
      if(from && t < from.getTime()) return false;
      if(to && t > to.getTime()) return false;
      return true;
    });
  }
  // [PATCH] searchFilterRows: incluir ignorados quando existe termo (AGORA S√ì USA O searchName do filtro principal)
  if(q){
    rows = rows.filter(r => {
        const hist = (r.hist||'').toLowerCase();
        const n = cleanRawName(hist).toLowerCase();
        return hist.includes(q) || n.includes(q);
    });
  }
  
  // CORRE√á√ÉO: O filtro de hiddenGroups foi movido para dentro do buildAggregations
  // para permitir que o acorde√£o tenha a lista completa.

  filtered = rows;
  
  // CORRE√á√ÉO: Ordena o array filtrado por data
  filtered.sort((a, b) => {
    if (a.dateObj && b.dateObj) {
      // Ordena√ß√£o cronol√≥gica correta
      return a.dateObj.getTime() - b.dateObj.getTime();
    }
    return 0; // Mant√©m a ordem se houver datas inv√°lidas
  });
  
  saveFilters(); // Salva filtros aplicados
}

// [PATCH ADDED: assignTransactionToGroup helper]
function assignTransactionToGroup(txId, targetGroupName, saveAlias = false){
  // Permite passar um Set de IDs para A√ß√£o em Massa
  const idsToMove = Array.isArray(txId) ? txId : [txId];

  idsToMove.forEach(id => {
      const tx = rawRows.find(r => r.txId === id);
      if(!tx) return;

      // remove de ignored se estava
      if(ignoredTransactions.has(id)) { 
          ignoredTransactions.delete(id); 
          saveIgnoredTransactions(ignoredTransactions); 
      }
      
      // se estava selecionado para a√ß√£o em massa, deseleciona
      selectedTransactions.delete(id); 

      // atualiza alias se solicitado
      const canonical = canonicalKey(cleanRawName(tx.hist));
      if (saveAlias && canonical) {
        NAME_ALIASES[canonical] = targetGroupName;
        // Salva os aliases aqui, mas n√£o chama updateAll() ainda
        localStorage.setItem('fin_v5_aliases', JSON.stringify(NAME_ALIASES, null, 2));
      } else if (canonical) {
        // Isso apenas afeta a agrega√ß√£o atual (session)
        nameMap[canonical] = targetGroupName;
      }
  });
  
  // Re-renderiza UMA VEZ ap√≥s todas as altera√ß√µes
  updateAll();
  alert(`Movidas ${idsToMove.length} transa√ß√µes para o grupo "${targetGroupName}".`);
}

// NOVO: Centraliza a agrega√ß√£o de dados
function buildAggregations() {
  // 1) AGREGA√á√ÉO COMPLETA (Acorde√£o)
  const accordionNameAgg = {};
  const accordionNameMap = {};
  filtered.forEach((f) => {
    const name = normalizeAndMapName(f.hist, accordionNameMap);
    if (name) {
      if (!accordionNameAgg[name]) accordionNameAgg[name] = { name, total: 0, credit: 0, debit: 0, count: 0, transactions: [], absTotal: 0 };
      const creditVal = Math.abs(f.credit);
      const debitVal = Math.abs(f.debit);
      accordionNameAgg[name].total += (creditVal - debitVal);
      accordionNameAgg[name].credit += creditVal;
      accordionNameAgg[name].debit += debitVal;
      accordionNameAgg[name].count++;
      accordionNameAgg[name].transactions.push(f);
      accordionNameAgg[name].absTotal += (creditVal + debitVal);
    }
  });
  
// [PATCH] Merge / remap de grupos se shouldGroupUnknown estiver ativo
nameMap = accordionNameMap;
const mergedBuckets = {};
Object.values(accordionNameAgg).forEach(g => {
  let displayName = g.name;
  if (shouldGroupUnknown) {
    const low = (g.name || '').toString().trim().toLowerCase();
    const isUnknown = !low || low === '' || low.includes('desconhecido') || low === 'undefined';
    if (isUnknown) displayName = 'Outros Gastos'; // MUDAN√áA: Usar 'Outros Gastos'
  }
  if (!mergedBuckets[displayName]) {
    mergedBuckets[displayName] = { name: displayName, total: 0, credit: 0, debit: 0, count: 0, transactions: [], absTotal: 0 };
  }
  mergedBuckets[displayName].total += (g.total || 0);
  mergedBuckets[displayName].credit += (g.credit || 0);
  mergedBuckets[displayName].debit += (g.debit || 0);
  mergedBuckets[displayName].count += (g.count || 0);
  mergedBuckets[displayName].transactions = mergedBuckets[displayName].transactions.concat(g.transactions || []);
  mergedBuckets[displayName].absTotal += (g.absTotal || 0);
});
accordionAggArr = Object.values(mergedBuckets);

// recalcula nomes ignorados a partir dos buckets finais, EXCLUINDO o bucket Outros
IGNORED_GROUP_NAMES = new Set(
  accordionAggArr
    .filter(g => {
      if (!g.name) return false;
      const low = g.name.toString().trim().toLowerCase();
      if (low === 'outros gastos') return false; // CORRE√á√ÉO: N√£o marcar 'Outros Gastos' como ignorado
      return INTERNAL_NAME_REGEX.some(rx => rx.test(g.name));
    })
    .map(g => g.name)
);

  // 2) AGREGA√á√ÉO FILTRADA (Gr√°ficos e Resumo)
  const chartRows = filtered.filter(f => {
    // [PATCH] Inclui transa√ß√µes individuais ignoradas (seja por hiddenGroups ou ignoredTransactions)
    if (ignoredTransactions.has(f.txId)) return false; 
    
    const groupName = nameMap[canonicalKey(cleanRawName(f.hist))] || normalizeAndMapName(f.hist, {});
    // Se n√£o deve mostrar ignorados E o grupo √© um grupo interno OU o grupo est√° oculto
    if (!shouldShowIgnored && (IGNORED_GROUP_NAMES.has(groupName) || hiddenGroups.has(groupName))) return false; 
    
    return true; // Passa se n√£o for um grupo interno/oculto
  });

  // 3) RE-AGREGA TUDO
  dayAgg = new Map();
  monthIn = {};
  monthOut = {};
  globalTotalIn = 0;
  globalTotalOut = 0;
  const chartNameAgg = {};
  
  chartRows.forEach(f => {
      const creditVal = Math.abs(f.credit);
      const debitVal = Math.abs(f.debit); 
      
      globalTotalIn += creditVal;
      globalTotalOut += debitVal;
      
      // Agrega√ß√£o de Nomes (para Top N)
      // Re-usa o mapa para consist√™ncia
      const name = nameMap[canonicalKey(cleanRawName(f.hist))] || normalizeAndMapName(f.hist, {});
      if (name) {
          if (!chartNameAgg[name]) chartNameAgg[name] = { total: 0, absTotal: 0 };
          chartNameAgg[name].total += (creditVal - debitVal);
          chartNameAgg[name].absTotal += (creditVal + debitVal);
      }
      
      // Agrega√ß√£o Di√°ria (Gr√°fico Di√°rio)
      if (f.dateObj) { // Verifica√ß√£o extra
        const v = creditVal + debitVal; 
        dayAgg.set(f.dateObj.getTime(), (dayAgg.get(f.dateObj.getTime()) || 0) + v);
      }
      
      // Agrega√ß√£o Mensal (Gr√°fico Mensal)
      const [d, m, y] = f.date.split('/');
      if (y && m) {
          const key = `${y}-${m}`; 
          if (creditVal > 0) monthIn[key] = (monthIn[key] || 0) + creditVal;
          if (debitVal > 0) monthOut[key] = (monthOut[key] || 0) + debitVal;
      }
  });

  globalSaldo = globalTotalIn - globalTotalOut;

  // 4. Process Outliers (baseado no 'dayAgg' filtrado)
  const dayVals = Array.from(dayAgg.values());
  const isOutlier = detectOutliersIQR(dayVals, 2.5);
  outlierIndexes = [];
  Array.from(dayAgg.keys()).forEach((key, i) => {
    if (isOutlier[i]) { // Usa o √≠ndice do array de valores
      outlierIndexes.push(i);
    }
  });

  // 5. Create sorted aggArr (para TopN chart)
  aggArr = Object.entries(chartNameAgg).map(([name, data]) => ({
    name,
    ...data
  }))
  .sort((a, b) => b.absTotal - a.absTotal);
}


// parse date input like dd/mm/yyyy or yyyy-mm-dd
function parseDateInput(s){
  if(!s) return null;
  s = s.trim();
  if(/\d{4}-\d{2}-\d{2}/.test(s)) return new Date(s);
  if(/\d{2}\/\d{2}\/\d{4}/.test(s)){
    const p = s.split('/');
    return new Date(p[2], p[1]-1, p[0]);
  }
  return null;
}

function renderSummary(){
  // NOVO: Usa os globais pr√©-calculados
  document.getElementById('totalIn').textContent = fmt(globalTotalIn);
  document.getElementById('totalOut').textContent = fmt(globalTotalOut);
  document.getElementById('saldo').textContent = fmt(globalSaldo);
  
  // CORRE√á√ÉO: Pega as datas do array 'filtered' que agora est√° ordenado
  const firstFiltered = filtered[0];
  const lastFiltered = filtered[filtered.length - 1];
  
  // CORRE√á√ÉO: Garante que as datas existem antes de tentar us√°-las
  const firstDateStr = firstFiltered && firstFiltered.date ? firstFiltered.date : '‚Äî';
  const lastDateStr = lastFiltered && lastFiltered.date ? lastFiltered.date : '‚Äî';
  
  document.getElementById('footerLeft').textContent = `Per√≠odo exibido: ${filtered.length? (firstDateStr + ' ‚Äî ' + lastDateStr) : '‚Äî'}`;
  document.getElementById('footerRight').textContent = `Total: ${fmt(globalSaldo)} ‚Ä¢ Transa√ß√µes: ${filtered.length}`;
}

/* ===== renderDaily (com outliers & zoom) ===== */

function renderDaily() {
  // Dados agora v√™m do buildAggregations()
  
  // SOLU√á√ÉO FINAL DE ORDENA√á√ÉO: O Map est√° usando TIMESTAMP
  const sortedLabels = Array.from(dayAgg.keys()); // Labels s√£o Timestamps (n√∫meros)
  let dayData = Array.from(dayAgg.values());

  // Mapeia os dados no formato que o Chart.js com type:'time' espera: [{x: timestamp, y: valor}, ...]
  const chartData = sortedLabels.map((timestamp, index) => ({
      x: new Date(Number(timestamp)), // Converte timestamp (milissegundos) de volta para objeto Date
      y: dayData[index]
  }));

  
  // CORRE√á√ÉO: Aplicando o toggle de outliers (aqui a l√≥gica de outlier fica complexa)
  // Vamos simplificar os outliers para usar o chartData diretamente:
  if (hideOutliers && chartData.length > 0) {
      const allValues = chartData.map(d => d.y);
      const isOutlier = detectOutliersIQR(allValues, 2.5);
      
      let nonOutlierSum = 0;
      let nonOutlierCount = 0;
      isOutlier.forEach((o, i) => {
          if (!o) { nonOutlierSum += allValues[i]; nonOutlierCount++; }
      });
      const mean = nonOutlierCount > 0 ? nonOutlierSum / nonOutlierCount : 0;
      
      const outliersFound = [];
      chartData.forEach((d, i) => {
          if (isOutlier[i]) {
              const originalValue = d.y; // NOVO: Guarda o valor original
              d.y = mean; // Substitui outlier pela m√©dia
              outliersFound.push({ x: d.x, y: originalValue }); // NOVO: Adiciona o valor ORIGINAL √† lista
          }
      });

      // Atualiza lista de outliers (usando as datas originais)
      // Esta linha agora funciona corretamente porque 'outliersFound' tem os valores originais
      outliersListEl.innerHTML = `<b>Outliers Ocultos:</b> ${outliersFound.map(d => `${new Date(d.x).toLocaleDateString('pt-BR')} (${fmt(d.y)})`).join(', ')}`;
      outliersMini.textContent = `${outliersFound.length} outliers ocultos.`;
      outliersListEl.classList.toggle('hidden', outliersFound.length === 0);

  } else {
    outliersListEl.innerHTML = '';
    outliersMini.textContent = '';
    outliersListEl.classList.add('hidden');
  }


  // Cores do tema
  const chartLineColor = getCssVar('--chart-line');
  const chartGridColor = getCssVar('--chart-grid');
  const mutedColor = getCssVar('--muted');

  // C√°lculo do maximo para for√ßar a escala Y
  const maxVal = chartData.length > 0 ? Math.max(...chartData.map(d => d.y)) : 1000;

  // Se o gr√°fico existe, apenas atualiza os dados (melhor performance)
  if (chartDaily) {
    chartDaily.data.datasets[0].data = chartData;
    // CORRE√á√ÉO: Atualiza o maximo do eixo Y
    chartDaily.options.scales.y.max = maxVal * 1.1; 
    chartDaily.options.scales.x.ticks.color = mutedColor;
    chartDaily.options.scales.y.ticks.color = mutedColor;
    chartDaily.options.scales.x.grid.color = chartGridColor;
    chartDaily.options.scales.y.grid.color = chartGridColor;
    chartDaily.update('none'); // 'none' evita re-anima√ß√£o
    return;
  }

  const ctx = document.getElementById('dailyChart').getContext('2d');
  chartDaily = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [{
        data: chartData,
        borderColor: chartLineColor,
        backgroundColor: chartLineColor,
        fill: false,
        tension: 0.2,
        pointRadius: 2, // Pontos menores
        pointHoverRadius: 5,
        spanGaps: true // NOVO: Diz ao gr√°fico para conectar linhas mesmo se houver "buracos" (dias sem dados)
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'nearest', intersect: false },
      scales: {
        x: {
            type: 'time', 
            time: {
                // N√£o precisa de parser porque estamos usando objetos Date/Timestamps
                tooltipFormat: 'dd/MM/yyyy',
                unit: 'day', // Ajusta automaticamente para a unidade mais apropriada
                displayFormats: {
                    day: 'dd/MM/yyyy',
                    week: 'dd/MM',
                    month: 'MM/yyyy',
                    year: 'yyyy'
                }
            },
            ticks: { 
                color: mutedColor,
                autoSkip: true, 
                maxRotation: 45,
                minRotation: 45,
            },
            grid: { color: chartGridColor } 
        },
        y: {
          beginAtZero: true, 
          // CORRE√á√ÉO: Definindo o valor m√°ximo para for√ßar a escala correta
          max: maxVal * 1.1,
          ticks: {
            color: mutedColor,
            callback: v => fmt(v)
          },
          grid: { color: chartGridColor }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: items => {
                const date = new Date(items[0].parsed.x);
                return date.toLocaleDateString('pt-BR');
            },
            label: ctx => ` ${fmt(ctx.parsed.y)}`
          }
        },
        zoom: {
          pan: { enabled: true, mode: 'x' },
          zoom: {
            wheel: { enabled: true, modifierKey: 'ctrl', passive: true },
            pinch: { enabled: true },
            mode: 'x'
          }
        }
      },
      onClick: (evt, elems) => {
        if (!elems.length || !chartData.length) return;
        const index = elems[0].element.index;
        const timestamp = chartData[index].x.getTime();
        const date = new Date(timestamp);
        
        // Formata para o formato YYYY-MM-DD para preencher o input type="date"
        const isoDate = date.toISOString().split('T')[0];
        // Nota: dateFrom/dateTo n√£o existem no HTML que voc√™ me mandou,
        // mas vamos assumir que est√£o l√° para fins de filtro.
        document.getElementById('dateFrom').value = isoDate;
        document.getElementById('dateTo').value = isoDate;
        // document.getElementById('applyDate').click(); // Dispara o filtro
        updateAll(); // Atualiza, usando os valores dos inputs
      }
    }
  });
}

/* ========== Mensal (MELHORADO) ========== */
function renderMonthly() {
  // Dados agora v√™m do buildAggregations()
  const keys = new Set([...Object.keys(monthIn), ...Object.keys(monthOut)]);
  const labels = Array.from(keys).sort(); // Ordena YYYY-MM

  const dataIn = labels.map(k => monthIn[k] || 0);
  const dataOut = labels.map(k => monthOut[k] || 0);

  // Cores do tema
  const greenColor = 'rgba(16, 185, 129, 0.7)'; // getCssVar('--green') com alpha
  const redColor = 'rgba(239, 68, 68, 0.7)'; // getCssVar('--red') com alpha
  const chartGridColor = getCssVar('--chart-grid');
  const mutedColor = getCssVar('--muted');

  if (chartMonthly) {
      chartMonthly.data.labels = labels.map(k => k.split('-').reverse().join('/'));
      chartMonthly.data.datasets[0].data = dataIn;
      chartMonthly.data.datasets[1].data = dataOut;
      chartMonthly.options.scales.x.ticks.color = mutedColor;
      chartMonthly.options.scales.y.ticks.color = mutedColor;
      chartMonthly.options.scales.x.grid.color = chartGridColor;
      chartMonthly.options.scales.y.grid.color = chartGridColor;
      chartMonthly.options.plugins.legend.labels.color = mutedColor;
      chartMonthly.update('none');
      return;
  }

  const ctx = document.getElementById('monthChart').getContext('2d');
  chartMonthly = new Chart(ctx, {
    type: 'bar', // MUDADO para bar
    data: {
      labels: labels.map(k => k.split('-').reverse().join('/')), // Formata para MM/YYYY
      datasets: [
        {
          label: 'Entradas',
          data: dataIn,
          backgroundColor: greenColor,
        },
        {
          label: 'Sa√≠das',
          data: dataOut,
          backgroundColor: redColor,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { color: mutedColor }, grid: { color: chartGridColor }, stacked: false },
        y: {
          ticks: { color: mutedColor, callback: v => fmt(v) },
          grid: { color: chartGridColor },
          stacked: false
        }
      },
      plugins: {
        legend: { position: 'bottom', labels: { color: mutedColor } },
        tooltip: { callbacks: { label: ctx => ` ${fmt(ctx.parsed.y)}` } },
        zoom: {
          pan: { enabled: true, mode: 'x' },
          zoom: { wheel: { enabled: true, modifierKey: 'ctrl' }, mode: 'x' }
        }
      }
    }
  });
}


/* ========== Top Destinat√°rios (CORRIGIDO) ========== */
function renderTop() {
  const n = parseInt(topN.value || 15, 10);
  // Usa o aggArr global (que j√° est√° filtrado e ordenado por valor)
  const top = aggArr.slice(0, n);
  const labels = top.map(x => x.name);
  const vals = top.map(x => x.total); // BUGFIX: Usar .total (l√≠quido) em vez de .absTotal

  // Cores baseadas no valor (positivo/negativo)
  const greenColor = 'rgba(16, 185, 129, 0.7)';
  const redColor = 'rgba(239, 68, 68, 0.7)';
  const greenBorder = 'rgba(16, 185, 129, 1)';
  const redBorder = 'rgba(239, 68, 68, 1)';

  const bgColors = vals.map(v => v >= 0 ? greenColor : redColor);
  const borderColors = vals.map(v => v >= 0 ? greenBorder : redBorder);

  const chartGridColor = getCssVar('--chart-grid');
  const mutedColor = getCssVar('--muted');

  if (barChart) {
    barChart.data.labels = labels;
    barChart.data.datasets[0].data = vals;
    barChart.data.datasets[0].backgroundColor = bgColors;
    barChart.data.datasets[0].borderColor = borderColors;
    barChart.options.scales.x.ticks.color = mutedColor;
    barChart.options.scales.y.ticks.color = mutedColor;
    barChart.options.scales.x.grid.color = chartGridColor;
    barChart.options.scales.y.grid.color = chartGridColor;
    barChart.update('none');
    return;
  }

  const ctxBar = document.getElementById('barChart').getContext('2d');
  barChart = new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: vals,
        backgroundColor: bgColors,
        borderColor: borderColors,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { color: mutedColor }, grid: { color: chartGridColor } },
        y: {
          ticks: { color: mutedColor, callback: v => fmt(v) },
          grid: { color: chartGridColor }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => ` ${fmt(ctx.parsed.y)}` } },
        zoom: {
          pan: { enabled: true, mode: 'x' },
          zoom: { wheel: { enabled: true, modifierKey: 'ctrl' }, mode: 'x' }
        }
      }
    }
  });
}

/* ========== Insights 2.0 (REFEITO) ========== */
function renderInsights() {
    insightsContainer.innerHTML = ''; // Limpa

    if (filtered.length === 0) {
        insightsContainer.innerHTML = `<p class="small-muted">Carregue um arquivo para ver os insights.</p>`;
        return;
    }

    // --- 1. An√°lise de Equil√≠brio ---
    const total = globalTotalIn + globalTotalOut;
    const inPct = total > 0 ? (globalTotalIn / total * 100).toFixed(1) : 0;
    const outPct = total > 0 ? (globalTotalOut / total * 100).toFixed(1) : 0;

    insightsContainer.innerHTML += `
      <div class="insight-card full-width">
        <div class="small-muted">An√°lise de Equil√≠brio</div>
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:4px;">
          <div class="insight-accent-green">
            <span>Entradas</span>
            <h4 style="line-height:1;">${fmt(globalTotalIn)}</h4>
          </div>
          <div class="insight-accent-red" style="text-align:right;">
            <span>Sa√≠das</span>
            <h4 style="line-height:1;">${fmt(globalTotalOut)}</h4>
          </div>
        </div>
        <div class="balance-bar-container">
          <div class="balance-bar-in" style="width: ${inPct}%" title="Entradas: ${inPct}%"></div>
          <div class="balance-bar-out" style="width: ${outPct}%" title="Sa√≠das: ${outPct}%"></div>
        </div>
      </div>`;

    // --- 2. Ritmo Financeiro (Semanal) ---
    const firstDate = filtered.length > 0 ? filtered[0]?.dateObj : null;
    const lastDate = filtered.length > 0 ? filtered[filtered.length - 1]?.dateObj : null;
    let numWeeks = 1;
    if (firstDate && lastDate) {
        const diffTime = Math.abs(lastDate.getTime() - firstDate.getTime());
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 para incluir o dia
        numWeeks = Math.max(1, diffDays / 7);
    }
    const avgInWeek = globalTotalIn / numWeeks;
    const avgOutWeek = globalTotalOut / numWeeks;

    insightsContainer.innerHTML += `
      <div class="insight-card">
        <div class="small-muted">Ritmo Financeiro (M√©dia Semanal)</div>
        <h4 class="insight-accent-green" style="margin-bottom: 4px;">+ ${fmt(avgInWeek)}</h4>
        <h4 class="insight-accent-red">- ${fmt(avgOutWeek)}</h4>
      </div>`;

    // --- 3. M√™s Mais / Menos ---
    let bestMonth = { key: '‚Äî', val: -Infinity };
    let worstMonth = { key: '‚Äî', val: Infinity };

    const keys = new Set([...Object.keys(monthIn), ...Object.keys(monthOut)]);
    if (keys.size > 0) {
        keys.forEach(k => {
            const saldoMes = (monthIn[k] || 0) - (monthOut[k] || 0);
            if (saldoMes > bestMonth.val) bestMonth = { key: k.split('-').reverse().join('/'), val: saldoMes };
            if (saldoMes < worstMonth.val) worstMonth = { key: k.split('-').reverse().join('/'), val: saldoMes };
        });
    }

    insightsContainer.innerHTML += `
      <div class="insight-card">
        <div class="small-muted">M√™s Mais Saud√°vel / Cr√≠tico</div>
        <h4 class="insight-accent-green" style="margin-bottom: 4px;">‚úÖ ${bestMonth.key} (${fmt(bestMonth.val)})</h4>
        <h4 class="insight-accent-red">üö® ${worstMonth.key} (${fmt(worstMonth.val)})</h4>
      </div>`;

    // --- 4. Picos de Movimento ---
    const maxIn = filtered.reduce((max, r) => Math.abs(r.credit) > max.val ? {val: Math.abs(r.credit), hist: r.hist} : max, {val:0, hist: '‚Äî'});
    const maxOut = filtered.reduce((max, r) => Math.abs(r.debit) > max.val ? {val: Math.abs(r.debit), hist: r.hist} : max, {val:0, hist: '‚Äî'});

    insightsContainer.innerHTML += `
      <div class="insight-card">
        <div class="small-muted">Picos de Movimento</div>
        <h4 class="insight-accent-green" style="margin-bottom: 4px;" title="${maxIn.hist}">üìà Maior Entrada: ${fmt(maxIn.val)}</h4>
        <h4 class="insight-accent-red" title="${maxOut.hist}">üí• Maior Sa√≠da: ${fmt(maxOut.val)}</h4>
      </div>`;
}

// ========================================================
// NOVO: Fun√ß√µes do Modal de Mover Transa√ß√£o com Autocompletar (CONSOLIDADO)
// ========================================================

// NOVO: Atualiza o bot√£o de mover em massa
function updateBulkMoveButton() {
  if (selectedTransactions.size > 0) {
    bulkCount.textContent = selectedTransactions.size;
    bulkMoveBtn.style.display = 'inline-block';
  } else {
    bulkMoveBtn.style.display = 'none';
  }
}

function showMoveTxModal(txId) {
    currentTxIdToMove = txId;
    const tx = rawRows.find(r => r.txId === txId);
    if (!tx) return alert('Transa√ß√£o n√£o encontrada');

    // 1. Prepara o modal
    txMoveHistDisplay.textContent = `Transa√ß√£o: ${tx.hist}`;
    groupNameInput.value = '';
    saveAliasCheckbox.checked = false;
    autocompleteList.innerHTML = '';
    autocompleteList.style.display = 'none';
    
    // 2. Exibe o modal
    moveTxModal.style.display = 'flex';
    groupNameInput.focus();
}

// NOVO: Fun√ß√£o para o modal de A√ß√£o em Massa
function showBulkMoveModal() {
    if (selectedTransactions.size === 0) return;
    currentTxIdToMove = Array.from(selectedTransactions); // Passa o array de IDs
    
    // 1. Prepara o modal
    txMoveHistDisplay.textContent = `${selectedTransactions.size} Transa√ß√µes selecionadas.`;
    groupNameInput.value = '';
    saveAliasCheckbox.checked = true; // Sugere salvar como alias para a√ß√£o em massa
    autocompleteList.innerHTML = '';
    autocompleteList.style.display = 'none';
    
    // 2. Exibe o modal
    moveTxModal.style.display = 'flex';
    groupNameInput.focus();
}


function handleAutocomplete(term) {
    autocompleteList.innerHTML = '';
    if (term.length < 2) {
        autocompleteList.style.display = 'none';
        return;
    }

    const lowerTerm = removeAccents(term).toLowerCase();
    
    // Coleta nomes de grupos existentes (j√° agrupados)
    const existingGroupNames = new Set(accordionAggArr.map(g => g.name).filter(name => name && name !== 'Outros Gastos'));
    
    const suggestions = Array.from(existingGroupNames).filter(name => 
        removeAccents(name).toLowerCase().includes(lowerTerm)
    ).slice(0, 5); // Limita a 5 sugest√µes

    if (suggestions.length === 0) {
        autocompleteList.style.display = 'none';
        return;
    }

    suggestions.forEach(name => {
        const div = document.createElement('div');
        div.className = 'autocomplete-suggestion';
        div.textContent = name;
        div.addEventListener('click', (e) => {
            e.stopPropagation();
            groupNameInput.value = name;
            autocompleteList.style.display = 'none';
            confirmMoveBtn.focus();
        });
        autocompleteList.appendChild(div);
    });

    autocompleteList.style.display = 'block';
}

// NOVO: Gerencia a sele√ß√£o de transa√ß√µes
function handleTransactionSelection(txId, isChecked) {
    const itemEl = document.querySelector(`.tx-item[data-txid="${txId}"]`);
    if (!itemEl) return;
    
    if (isChecked) {
        selectedTransactions.add(txId);
        itemEl.classList.add('tx-selected');
    } else {
        selectedTransactions.delete(txId);
        itemEl.classList.remove('tx-selected');
    }
    updateBulkMoveButton();
}

// NOVO: Gerencia a sele√ß√£o por grupo (A√ß√£o em Massa)
function handleGroupSelection(groupName, isChecked) {
    const group = accordionAggArr.find(g => g.name === groupName);
    if (!group) return;

    // Obt√©m os txIds das transa√ß√µes VIS√çVEIS no acorde√£o (para respeitar pagina√ß√£o/busca)
    const visibleTxIdsInGroup = Array.from(document.querySelectorAll(`#accordionContainer .accordion-item .tx-item[data-txid]`))
                            .map(el => el.dataset.txid)
                            .filter(txId => group.transactions.some(tx => tx.txId === txId));

    group.transactions.forEach(tx => {
        // S√≥ interage com transa√ß√µes que est√£o atualmente vis√≠veis no DOM
        if (visibleTxIdsInGroup.includes(tx.txId)) { 
            const checkbox = document.querySelector(`.tx-select-checkbox[data-txid="${tx.txId}"]`);
            if (checkbox) {
                checkbox.checked = isChecked;
            }
            handleTransactionSelection(tx.txId, isChecked);
        }
    });
}

/* ========== NOVO: Render Accordion (BUSCA CORRIGIDA) ========== */
function renderAccordion() {
  const container = document.getElementById('accordionContainer');
  let listToSort = [...accordionAggArr];

  // NOVO: filtro por busca (CORRIGIDO)
  const searchQuery = accordionSearch.value.toLowerCase();
  
  // 1. FILTRA POR TERMO DE BUSCA (Group Name ou Transa√ß√£o)
  let transactionsMatchingSearch = new Set(); 

  // A busca √© aplicada no array completo do Acorde√£o
  if (searchQuery) {
      listToSort.forEach(group => {
          const nameMatch = removeAccents(group.name).toLowerCase().includes(searchQuery);
          group.transactions.forEach(tx => {
              const histMatch = (tx.hist || '').toLowerCase().includes(searchQuery);
              if (nameMatch || histMatch) {
                  transactionsMatchingSearch.add(tx.txId);
              }
          });
      });
  }

  // 2. FILTRA QUAIS GRUPOS SER√ÉO MOSTRADOS
  // Se houver busca, mostramos todos os grupos que cont√™m transa√ß√µes relevantes.
  if (!searchQuery) {
      // Se n√£o houver busca, aplicamos o filtro de ignorados/ocultos
      if (!shouldShowIgnored) {
          listToSort = listToSort.filter(g => !IGNORED_GROUP_NAMES.has(g.name));
      }
      listToSort = listToSort.filter(g => !hiddenGroups.has(g.name)); 

  } else {
      // Se houver busca: mostra APENAS grupos que cont√™m transa√ß√µes que deram match
      listToSort = listToSort.filter(group => {
          return group.transactions.some(tx => transactionsMatchingSearch.has(tx.txId));
      });
  }

  // 3. Aplica sorteio
  if (accordionSortOrder === 'name') {
    listToSort.sort((a, b) => a.name.localeCompare(b.name));
  } else if (accordionSortOrder === 'credit_desc') { // ATUALIZADO
    listToSort.sort((a, b) => b.credit - a.credit);
  } else if (accordionSortOrder === 'credit_asc') { // ATUALIZADO
    listToSort.sort((a, b) => a.credit - b.credit);
  } else if (accordionSortOrder === 'debit_desc') { // ATUALIZADO
    listToSort.sort((a, b) => b.debit - a.debit);
  } else if (accordionSortOrder === 'debit_asc') { // ATUALIZADO
    listToSort.sort((a, b) => a.debit - b.debit);
  } else { // 'count'
    listToSort.sort((a, b) => b.count - a.count);
  }
  
  // NOVO: Aplica pagina√ß√£o
  const itemsToShow = listToSort.slice(0, accordionPageSize);

  // Limpa o container
  container.innerHTML = '';
  
  // Limpa a lista de ignorados antes de renderizar (se for usada)
  const ignoredSection = document.getElementById('ignoredSection');
  const ignoredList = document.getElementById('ignoredList');
  if (ignoredList) ignoredList.innerHTML = '';

  if (itemsToShow.length === 0 && searchQuery) {
    container.innerHTML = `<div class="small-muted" style="padding:10px;">Nenhuma transa√ß√£o encontrada para o termo "${searchQuery}".</div>`;
  } else if (itemsToShow.length === 0) {
    container.innerHTML = `<div class="small-muted" style="padding:10px;">Nenhuma transa√ß√£o para os filtros aplicados.</div>`;
  }

  // Percorre os grupos a mostrar no acorde√£o
  itemsToShow.forEach(group => {
    const groupNameEscaped = (group.name||'').replace(/"/g, '&quot;');
    const isHidden = hiddenGroups.has(group.name);
    const isIgnoredGroupName = IGNORED_GROUP_NAMES.has(group.name);

    // EXCE√á√ÉO: manter o bucket "Outros Gastos" vis√≠vel por padr√£o
    const groupNameLower = (group.name||'').toString().trim().toLowerCase();
    const isOthersBucket = groupNameLower === 'outros gastos';

    // Se o grupo est√° oculto e shouldShowIgnored -> renderiza na se√ß√£o ignoredList
    if (isHidden && shouldShowIgnored) {
        // ... (l√≥gica de renderizar ignoredList se voc√™ tivesse o container no HTML)
    }

    // Caso normal: renderiza no acorde√£o
    const item = document.createElement('div');
    item.className = 'accordion-item';
    item.classList.toggle('ignored-item', isIgnoredGroupName);
    
    // NOVO: Checkbox para selecionar todas as transa√ß√µes do grupo (dentro do conte√∫do)
    const allGroupTransactions = group.transactions.filter(t => !searchQuery || transactionsMatchingSearch.has(t.txId));
    const allVisibleSelected = allGroupTransactions.length > 0 && allGroupTransactions.every(t => selectedTransactions.has(t.txId));
    
    // CONSOLIDADO: Template do checkbox de sele√ß√£o em massa (do arquivo `const selectAllHtml =...js`)
    const selectAllHtml = allGroupTransactions.length > 0 ? `
        <div style="display: flex; align-items: center; justify-content: flex-start; padding: 6px 0; border-bottom: 1px solid var(--glass);">
            <input type="checkbox" class="group-select-checkbox-all" data-group-name="${groupNameEscaped}" ${allVisibleSelected ? 'checked' : ''} style="margin-right: 8px;">
            <span class="small-muted" style="font-weight: 500;">Selecionar todas (${allGroupTransactions.length} transa√ß√µes)</span>
        </div>
    ` : '';
    
    // Monta HTML das transa√ß√µes (mant√©m a sua l√≥gica atual de txHtml e os novos bot√µes)
    let txHtml = (group.transactions || [])
      .sort((a,b) => (b.dateObj?.getTime?.() || 0) - (a.dateObj?.getTime?.() || 0))
      .map(t => {
        // Filtro de Transa√ß√£o: Se h√° busca, mostra S√ì as que deram match
        if (searchQuery && !transactionsMatchingSearch.has(t.txId)) return '';
          
        const creditVal = Math.abs(t.credit || 0);
        const debitVal = Math.abs(t.debit || 0);
        const isTxIgnored = ignoredTransactions.has(t.txId);
        const isSelected = selectedTransactions.has(t.txId); // NOVO: Estado de sele√ß√£o
          
        return `
          <div class="tx-item ${isTxIgnored ? 'tx-ignored' : ''} ${isSelected ? 'tx-selected' : ''}" data-txid="${t.txId}">
            <input type="checkbox" class="tx-select-checkbox" data-txid="${t.txId}" ${isSelected ? 'checked' : ''} style="margin-right: 8px;">

            <span class="tx-date">${t.date || ''}</span>
            <span class="tx-hist" title="${(t.hist||'').replace(/"/g,'&quot;')}">${t.hist || ''}</span>
            <span class="tx-credit">${creditVal > 0 ? fmt(creditVal) : '‚Äî'}</span>
            <span class="tx-debit">${debitVal > 0 ? fmt(debitVal) : '‚Äî'}</span>
            <button class="tx-ignore-btn" data-id="${t.txId}" title="${isTxIgnored ? 'Reexibir transa√ß√£o' : 'Ignorar transa√ß√£o'}">${isTxIgnored ? '‚óè' : '‚óã'}</button>
            <button class="tx-edit-btn" data-id="${t.txId}" title="Editar descri√ß√£o">‚úé</button>
            <button class="tx-move-btn" data-id="${t.txId}" title="Mover transa√ß√£o">‚Üí</button>
          </div>
        `;
      }).join('');

    item.innerHTML = `
      <div class="accordion-header">
        <span class="accordion-name">
          <span class="accordion-hide-icon ${isHidden ? 'hidden' : ''}" 
                 title="${isHidden ? 'Clique para Reexibir' : 'Clique para Ocultar'}"
                 data-group-name="${groupNameEscaped}">
          </span> 
          
          <span class="accordion-name-display" title="Clique duplo para renomear">${group.name} (${group.count})</span>
          
        </span>
        
        <span class="accordion-total-credit">${fmt(group.credit)}</span>
        <span class="accordion-total-debit">${fmt(group.debit)}</span>
        
        <span class="accordion-icon">‚ñ∂</span>
      </div>
      <div class="accordion-content">
        ${selectAllHtml}
        ${txHtml}
      </div>
    `;
    container.appendChild(item);
  });
  
  // NOVO: Controla o bot√£o "Ver mais"
  const accordionLoadMore = document.getElementById('accordionLoadMore');
  if (accordionPageSize >= listToSort.length) {
    accordionLoadMore.style.display = 'none'; // Todos os items est√£o vis√≠veis
  } else {
    accordionLoadMore.style.display = 'block';
  }

}


/* ===========================
   Event Listeners
   =========================== */

// Delegation: ignorar / editar / mover transa√ß√µes (um handler para tudo)
document.body.addEventListener('click', (e) => {
  
  // L√≥gica de sele√ß√£o por Transa√ß√£o (CONSOLIDADO)
  const txCheckbox = e.target.closest('.tx-select-checkbox');
  if (txCheckbox) {
      const txId = txCheckbox.dataset.txid;
      handleTransactionSelection(txId, txCheckbox.checked);
      return;
  }
    
  // L√≥gica de sele√ß√£o por Grupo (A√á√ÉO EM MASSA - NOVO CHECKBOX DENTRO DO CONTE√öDO) (CONSOLIDADO)
  const groupCheckboxAll = e.target.closest('.group-select-checkbox-all');
  if (groupCheckboxAll) {
      const groupName = groupCheckboxAll.dataset.groupName;
      // Usamos setTimeout para garantir que o estado do checkbox foi atualizado no DOM
      setTimeout(() => {
          handleGroupSelection(groupName, groupCheckboxAll.checked);
      }, 0);
      return;
  }
    
  const ig = e.target.closest('.tx-ignore-btn');
  if (ig) {
    const id = ig.dataset.id;
    if (!id) return;
    if (ignoredTransactions.has(id)) { // desmarcar
      ignoredTransactions.delete(id);
    } else {
      ignoredTransactions.add(id);
    }
    saveIgnoredTransactions(ignoredTransactions);
    updateAll();
    return;
  }

  const ed = e.target.closest('.tx-edit-btn');
  if (ed) {
    const id = ed.dataset.id;
    if(!id) return;
    const tx = rawRows.find(r => r.txId === id);
    if (!tx) return alert('Transa√ß√£o n√£o encontrada');
    const novo = prompt('Editar descri√ß√£o da transa√ß√£o:', tx.hist || '');
    if (novo === null) return;
    tx.hist = novo.trim();
    updateAll();
    return;
  }

  const mv = e.target.closest('.tx-move-btn');
  if (mv) {
    const id = mv.dataset.id;
    if(!id) return;
    
    // CHAMA O NOVO MODAL PARA TRANSA√á√ÉO √öNICA
    showMoveTxModal(id);
    return;
  }
});

// Listener para o bot√£o de A√ß√£o em Massa (CONSOLIDADO)
bulkMoveBtn.addEventListener('click', showBulkMoveModal);

// Event Listeners do Modal (CONSOLIDADO)
groupNameInput.addEventListener('input', debounce(() => {
    handleAutocomplete(groupNameInput.value);
}, 100));

confirmMoveBtn.addEventListener('click', () => {
    const group = groupNameInput.value.trim();
    if (!group) return alert('Digite um nome para o grupo.');
    const saveAlias = saveAliasCheckbox.checked;
    
    const idsToMove = Array.isArray(currentTxIdToMove) ? currentTxIdToMove : [currentTxIdToMove];
    
    assignTransactionToGroup(idsToMove, group, saveAlias);
    
    // Fecha e reseta
    moveTxModal.style.display = 'none';
    currentTxIdToMove = null;
});

cancelMoveBtn.addEventListener('click', () => {
    moveTxModal.style.display = 'none';
    currentTxIdToMove = null;
});


// Listener para abrir/fechar o acorde√£o (CORRE√á√ÉO DE BUG)
document.getElementById('accordionContainer').addEventListener('click', (e) => {
    const header = e.target.closest('.accordion-header');
    if (header) {
        // Se o clique foi em um elemento interativo interno, n√£o faz nada
        if (e.target.closest('.accordion-name-display') || 
            e.target.closest('.accordion-hide-icon') ||
            e.target.closest('input[type="checkbox"]') || // Cobre todos os checkboxes (transa√ß√£o e sele√ß√£o em massa)
            e.target.closest('button')) { // Cobre todos os bot√µes e √≠cones
            return;
        }

        const content = header.nextElementSibling;
        const icon = header.querySelector('.accordion-icon');
        const isActive = content.classList.toggle('active');
        icon.classList.toggle('rotated', isActive);

        // Fecha outros abertos (mantendo a l√≥gica de um por vez)
        if (isActive) {
            document.querySelectorAll('#accordionContainer .accordion-content.active').forEach(openContent => {
                if (openContent !== content) {
                    openContent.classList.remove('active');
                    openContent.previousElementSibling.querySelector('.accordion-icon').classList.remove('rotated');
                }
            });
        }
    }
});


// CORRE√á√ÉO: dblclick para Edi√ß√£o (RESTAURADO)
document.querySelectorAll('.wrap').forEach(wrap => { // Usa o container principal para delega√ß√£o
    wrap.addEventListener('dblclick', (e) => {
        const nameSpan = e.target.closest('.accordion-name-display');
        if (!nameSpan) return;
        
        e.stopPropagation(); // Impede que o acorde√£o se feche/abra
        
        const header = nameSpan.closest('.accordion-header');
        const groupNameSpan = header.querySelector('.accordion-name'); // O span pai
        const oldName = nameSpan.textContent.split(' (')[0]; // Pega o nome
        
        if (!groupNameSpan.querySelector('.accordion-edit-input')) { // Previne dblclick duplo
            
            // Substitui o span por um input
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'accordion-edit-input';
            input.value = oldName;
            input.onclick = (e) => e.stopPropagation(); // Impede que o clique feche

            // Substitui o √≠cone de editar por salvar
            const saveIcon = document.createElement('span');
            saveIcon.className = 'accordion-save-icon';
            saveIcon.title = 'Salvar novo nome';
            saveIcon.textContent = 'üíæ';
            saveIcon.onclick = (e) => {
              e.stopPropagation();
              const newName = input.value.trim();
              if (newName && newName !== oldName) {
                // L√≥gica de salvar alias
                const groupData = accordionAggArr.find(g => g.name === oldName);
                if (groupData) {
                    groupData.transactions.forEach(t => {
                        const key = canonicalKey(cleanRawName(t.hist));
                        if (key && !NAME_ALIASES[key]) {
                           NAME_ALIASES[key] = newName;
                        }
                    });
                    NAME_ALIASES[canonicalKey(oldName)] = newName;
                    
                    // Atualiza grupos ocultos
                    if (hiddenGroups.has(oldName)) {
                        hiddenGroups.delete(oldName);
                        hiddenGroups.add(newName); // Adiciona o novo nome √† lista de ocultos
                        localStorage.setItem('fin_v5_hidden_groups', JSON.stringify(Array.from(hiddenGroups)));
                    }
                  
                  nameAliasesEditor.value = JSON.stringify(NAME_ALIASES, null, 2);
                  saveNameAliases(); // Salva e chama updateAll()
                }
              } else {
                // Restaura
                groupNameSpan.replaceChild(nameSpan, input);
                groupNameSpan.removeChild(saveIcon);
              }
            };

            groupNameSpan.replaceChild(input, nameSpan);
            groupNameSpan.appendChild(saveIcon); // Adiciona o saveIcon
            input.focus();
            input.select();
        }
    });
});


// ATUALIZADO: Listeners para Ocultar Grupo (Bolinha - CORRIGIDO)
document.querySelectorAll('.wrap').forEach(wrap => {
    wrap.addEventListener('click', (e) => {
        const icon = e.target.closest('.accordion-hide-icon');
        if (!icon) return;
        
        e.stopPropagation(); // Impede que o acorde√£o expanda
        const groupName = icon.dataset.groupName;
        
        // CORRE√á√ÉO: L√≥gica de Ocultar/Reexibir
        const isCurrentlyHidden = hiddenGroups.has(groupName); // Usa o Set global
        
        if (isCurrentlyHidden) {
          hiddenGroups.delete(groupName); // Reexibir
        } else {
          hiddenGroups.add(groupName); // Ocultar
        }
        
        // Salva a lista de grupos ocultos no localStorage
        localStorage.setItem('fin_v5_hidden_groups', JSON.stringify(Array.from(hiddenGroups)));
        
        // Recarrega o painel (ir√° re-renderizar o √≠cone e a lista)
        updateAll();
    });
});



/* --- Biru Patch de Import CSV Seguro (vibes jade m√≠stico) --- */

// Fun√ß√µes para controle visual do bot√£o CSV
function updateFileLabelState(state, text) {
    fileInputLabel.classList.remove('csv-loaded', 'csv-error');
    if (state === 'loaded') {
        fileInputLabel.classList.add('csv-loaded');
        fileInputLabel.textContent = text || 'CSV ‚úì';
    } else if (state === 'error') {
        fileInputLabel.classList.add('csv-error');
        fileInputLabel.textContent = text || 'Erro CSV ‚ùå';
    } else {
        fileInputLabel.textContent = text || 'CSV';
    }
}

if (fileInput) {
  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) {
      updateFileLabelState("default");
      return;
    }

    // Estado visual
    updateFileLabelState("loading", "Carregando CSV‚Ä¶");

    try {
      // Tentativa ISO primeiro (Bradesco vibes)
      try {
        await parseCSVFile(file, "ISO-8859-1");
      } catch (errISO) {
        console.warn("ISO falhou, tentando UTF-8", errISO);

        // Agora UTF-8
        await parseCSVFile(file, "utf-8");
      }

      // Se chegou aqui: deu boa ‚úÖ
      updateFileLabelState("loaded", "CSV ‚úì");

      // Atualiza dados no app
      // if (typeof recalc === "function") recalc(); // <--- üü¢ CORRIGIDO: CHAMADA REMOVIDA
      if (typeof updateAll === "function") updateAll();

    } catch (err) {
      console.error("CSV FAIL:", err);
      updateFileLabelState("error", "Erro CSV");
      alert("O CSV deu tilt ü•¥");
    } finally {
      // Permitir re-upload do mesmo arquivo
      try { fileInput.value = ""; } catch (_) {}
    }

  });
}


// Outros Listeners (para exportar/importar/tema/filtros)

// Event Listeners (simulando a exist√™ncia de Apply e Clear)
if (clearFilters) {
    clearFilters.addEventListener('click', () => {
        if(accordionSearch) accordionSearch.value = '';
        dateFrom.value = '';
        dateTo.value = '';
        clearYearFilterState();
        
        // NOVO: Limpa grupos ocultos
        hiddenGroups.clear();
        localStorage.setItem('fin_v5_hidden_groups', JSON.stringify([]));
        
        // NOVO: Reseta o sorteio e busca do acorde√£o
        accordionPageSize = 20;
        if(accordionSort) accordionSort.value = 'count';
        accordionSortOrder = 'count';
        if(accordionSearch) accordionSearch.value = '';
        
        // NOVO: Limpa sele√ß√£o em massa
        selectedTransactions.clear(); 
            
        // NOVO: Reseta os toggles do acorde√£o
        if(groupUnknownToggle) groupUnknownToggle.checked = false;
        if(showIgnoredToggle) showIgnoredToggle.checked = false;

        saveFilters(); 
        updateAll();
    });
}


if (applyDate) applyDate.addEventListener('click', updateAll);
if (accordionSearch) accordionSearch.addEventListener('input', debounce(updateAll, 400));
// dateFrom/dateTo n√£o existem, mas o updateAll() √© chamado via yearFilter
// Se voc√™ adicionar inputs de data na UI, o listener DEVE ser adicionado neles.

if(topN) {
  topN.addEventListener('change', () => {
    document.getElementById('topCount').textContent = topN.value;
    saveFilters();
    updateAll();
  });
}

if(toggleOutliers) {
  toggleOutliers.addEventListener('change', () => {
    hideOutliers = toggleOutliers.checked;
    saveFilters();
    updateAll(); 
  });
}

// NOVO: Listener do Checkbox "Agrupar Desconhecidos"
if(groupUnknownToggle) {
    groupUnknownToggle.addEventListener('change', (e) => {
        shouldGroupUnknown = e.target.checked;
        saveFilters(); 
        updateAll(); 
    });
}

// NOVO: Listener do "Exibir ignorados"
if(showIgnoredToggle) {
    showIgnoredToggle.addEventListener('change', (e) => {
        shouldShowIgnored = e.target.checked;
        saveFilters(); 
        updateAll(); 
    });
}

// NOVO: Listener do Editor de Aliases
if(saveAliasesBtn) saveAliasesBtn.addEventListener('click', saveNameAliases);

// NOVO: Listener do Acorde√£o do Editor
const aliasEditorHeader = document.getElementById('aliasEditorHeader');
const aliasEditorContent = document.getElementById('aliasEditorContent');
const aliasEditorIcon = document.getElementById('aliasEditorIcon');

if (aliasEditorHeader) {
  aliasEditorHeader.addEventListener('click', () => {
    const isActive = aliasEditorContent.classList.toggle('active');
    aliasEditorIcon.classList.toggle('rotated', isActive);
  });
}

// ATUALIZADO: Listeners de Pagina√ß√£o e Sorteio do Acorde√£o
if(accordionSort) {
  accordionSort.addEventListener('change', (e) => {
    accordionSortOrder = e.target.value;
    accordionPageSize = 20; // Reseta a pagina√ß√£o ao mudar o sorteio
    renderAccordion();
  });
}

const accordionLoadMore = document.getElementById('accordionLoadMore');
if(accordionLoadMore) {
  accordionLoadMore.addEventListener('click', () => {
    accordionPageSize += 20; // Adiciona mais 20 items
    renderAccordion();
  });
}

// NOVO: Listener da Busca do Acorde√£o
if(accordionSearch) {
  accordionSearch.addEventListener('input', debounce(() => {
    accordionPageSize = 20; // Reseta a pagina√ß√£o ao buscar
    renderAccordion();
  }, 300));
}

// L√≥gica de Import/Export (MANTIDA)
// ... (c√≥digo para os bot√µes de backup e printScreen) ...


/* --- Theme Toggle --- */
if (themeToggle) {
  themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('light');
    const isLight = document.body.classList.contains('light');
    themeToggle.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('fin_v5_theme', isLight ? 'light' : 'dark');

    // Destr√≥i e recria gr√°ficos para aplicar cores do tema
    if(chartDaily) chartDaily.destroy(), chartDaily = null;
    if(chartMonthly) chartMonthly.destroy(), chartMonthly = null;
    if(barChart) barChart.destroy(), barChart = null;

    updateAll(); // Re-renderiza tudo
  });
}

(function initTheme() {
  const theme = localStorage.getItem('fin_v5_theme') || 'dark';
  if (theme === 'light') {
    document.body.classList.add('light');
    if (themeToggle) themeToggle.textContent = '‚òÄÔ∏è';
  } else {
    document.body.classList.remove('light'); // Garante que dark √© o padr√£o
    if (themeToggle) themeToggle.textContent = 'üåô';
  }
})();


/* ===========================
   Inicializa√ß√£o (Carrega Filtros e Aliases)
   =========================== */
(function(){
  loadFilters();
  loadNameAliases();
  // recalc(); // <--- üü¢ CORRIGIDO: CHAMADA REMOVIDA
  updateAll();
})();
</script>
</body>
</html>
